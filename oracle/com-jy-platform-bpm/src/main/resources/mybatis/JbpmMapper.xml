<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jy.platform.jbpm4.repository.JbpmMapper" >
  <resultMap id="Jbpm4FormInfoDTO" type="com.jy.platform.jbpm4.jbpm4FormInfo.dto.Jbpm4FormInfoDTO">
		<result property="id" column="ID" jdbcType="DECIMAL"/>
		<result property="validateState" column="VALIDATE_STATE" jdbcType="VARCHAR"/>
		<result property="createTime" column="CREATE_TIME"/>
		<result property="remark" column="REMARK" jdbcType="VARCHAR"/>
		<result property="ext1" column="EXT1" jdbcType="VARCHAR"/>
		<result property="ext2" column="EXT2" jdbcType="VARCHAR"/>
		<result property="ext3" column="EXT3" jdbcType="VARCHAR"/>
		<result property="proDefKey" column="PRO_DEF_KEY" jdbcType="VARCHAR"/>
		<result property="proActivityName" column="PRO_ACTIVITY_NAME" jdbcType="VARCHAR"/>
		<result property="proActivityForm" column="PRO_ACTIVITY_FORM" jdbcType="VARCHAR"/>
		<result property="participatorType" column="PARTICIPATOR_TYPE" jdbcType="VARCHAR"/>
		<result property="partType" column="PART_TYPE" jdbcType="VARCHAR"/>
		<result property="otherParams" column="OTHER_PARAMS" jdbcType="VARCHAR"/>
		<result property="ruleInfo" column="RULE_INFO" jdbcType="VARCHAR"/>
		<result property="proLevel" column="PRO_LEVEL" jdbcType="VARCHAR"/>
  </resultMap>
  
  <resultMap id="TemporaryJbpm4InfoDTO" type="com.jy.platform.jbpm4.temporaryJbpm4Info.dto.TemporaryJbpm4InfoDTO">
		<result property="id" column="ID" jdbcType="DECIMAL"/>
		<result property="validateState" column="VALIDATE_STATE" jdbcType="VARCHAR"/>
		<result property="lastUpdBy" column="LAST_UPD_BY" jdbcType="VARCHAR"/>
		<result property="lastUpd" column="LAST_UPD" />
		<result property="createdBy" column="CREATED_BY" jdbcType="VARCHAR"/>
		<result property="created" column="CREATED"/>
		<result property="remark" column="REMARK" jdbcType="VARCHAR"/>
		<result property="ext1" column="EXT1" jdbcType="VARCHAR"/>
		<result property="procVersion" column="PROC_VERSION" jdbcType="VARCHAR"/>
		<result property="procCode" column="PROC_CODE" jdbcType="VARCHAR"/>
		<result property="procName" column="PROC_NAME" jdbcType="VARCHAR"/>
		<result property="bizFile" column="BIZ_FILE" jdbcType="VARCHAR"/>
		<result property="totalRecordNum" column="TOTALRECORDNUM"/>
		<result property="num" column="NUM"/>
		<result property="xmlContent" column="XML_CONTENT" jdbcType="CLOB"  />
  </resultMap>
  <!-- 通过流程实例ID 获取流程定义信息 -->
  <select id="queryProDefindInfo" parameterType="java.util.Map" resultType="java.util.Map">
	  select  
	  		t1.OBJNAME_     pro_name	/*流程名称*/
	       ,t1.DEPLOYMENT_  deployment	/*流程部署ID*/
	       ,t2.stringval_   pro_key		/*流程定义key*/
	       ,t3.longval_    	version		/*流程版本号*/
	       ,t1.stringval_  	pro_def_id  /*流程定义ID*/
	       ,to_char((select tt1.name_ from jbpm4_lob tt1 where tt1.deployment_ = t1.deployment_)) resource_name /*流程资源名称*/
	  from JBPM4_DEPLOYMENT t,
	       JBPM4_DEPLOYPROP t1,
	       JBPM4_DEPLOYPROP t2,
	       JBPM4_DEPLOYPROP t3
	 where t1.KEY_ = 'pdid'
	   and t1.DEPLOYMENT_ = t.DBID_
	   and t2.KEY_ = 'pdkey'
	   and t2.OBJNAME_ = t1.OBJNAME_
	   and t2.DEPLOYMENT_ = t.DBID_
	   and t3.KEY_ = 'pdversion'
	   and t3.OBJNAME_ = t1.OBJNAME_
	   and t3.DEPLOYMENT_ = t.DBID_
	   and t1.STRINGVAL_ = (select hp.procdefid_ from jbpm4_hist_procinst hp where hp.id_=#{proInsId})
   </select>
   <!-- 查询某个人的待办任务数量 -->
   <select id="getTaskCunOfPseron" parameterType="java.util.Map" resultType="java.util.Map">
   select temp.*
		    ,(select to_char(t3.create_ ,'yyyy-MM-dd hh24:mi:ss') from jbpm4_task t3 
		   			 where t3.dbid_ = (select max(t2.dbid_) from jbpm4_task t2 where t2.assignee_ =#{userId})
		   	 )create_time
   	from (
   			select  
   			to_char(count(t1.dbid_))			task_cunt
	        from jbpm4_task            t1 
	        where 1 = 1
	        <if test="fastSQL == null or fastSQL== '' " >    
		    
	        and t1.state_  is not null
	        <!-- 流程实例是活动的 -->
	        and exists (select * from jbpm4_execution t2 where t2.id_ = t1.execution_id_ )
	         <!-- 后续可以添加业务中间表 jbpm4_biz_tab 有 活动的 主流程 -->
	        and (exists( select p.* from jbpm4_hist_procinst p  where p.state_ = 'active' and p.id_ = t1.execution_id_ 	<!-- 找主流程下所有子流程 包括并发流程/会签  -->
	          			)
	          	<!-- 只有主流程，没有子流程 -->	
	            or exists (select p1.*  from jbpm4_hist_procinst  p1  where p1.state_ = 'active' and p1.main_id_ is null 
				              and instr(t1.execution_id_,p1.id_) >0 /*支持非主子流程的 会签 */ )
	        )
	        </if>
	        and t1.assignee_ =#{userId}
   	)temp
   		
   </select>
 <!-- 查询某个人的当天分配的任务数量（包括待办、已办、已结） -->
 <select id="getTaskCunOfPseronToday" parameterType="java.util.Map" resultType="java.util.Map">
  	select  to_char(count(t1.dbid_)) task_cunt
  	,to_char(max(t1.create_),'YYYY-MM-DD HH24:MI:SS') create_time
    from jbpm4_hist_task t1 
    where t1.assignee_ ='${userId}'
            and to_char(t1.create_,'yyyy-MM-dd')=to_char(sysdate,'yyyy-MM-dd')             		
 </select>
<!-- jbpm4.4 自定义 待办任务查询 todo 主流程待办任务 支持主子流程、会签流程 -->
<select id="queryTasksByMySql_1" parameterType="java.util.Map" resultType="java.util.Map">
	SELECT TEMP.* FROM (
    select  ROWNUM NUM,
    T.*,
    count(1) over() totalRecordNum
    	from(
		        select 
		        t1.dbid_				taskId
		        ,t1.ACTIVITY_NAME_		cur_act_name
		        ,t1.EXECUTION_ID_		cur_exe_id
		        ,t1.lock_state
		        ,t1.ASSIGNEE_ 			cur_owner
		        ,to_char(t1.create_,'YYYY-MM-DD HH24:MI:SS') start_time
		        ,(select t3.id_ from jbpm4_execution t2,jbpm4_execution t3 where 1=1 and t3.dbid_ = t2.superexec_ and t2.id_ = t1.execution_id_) main_id
		        
		        <!-- 如果是自定义sql则展示 -->
		        <if test="dto.customSQL != null and dto.customSQL != '' " >    
	            ,(select b.biz_task_type from jbpm4_biz_tab b where b.pro_instance_id = t1.execution_id_) biz_task_type
	            ,(select case when b.task_state is null then '0' else b.task_state end from jbpm4_biz_tab b where b.pro_instance_id = t1.execution_id_) task_state
		        </if>
		        
		        from jbpm4_task            t1 
		        where 1 = 1 
		        and t1.state_  is not null
		        <!-- 流程实例是活动的 -->
		        and exists (select * from jbpm4_execution t2 where t2.id_ = t1.execution_id_ )
		         <!-- 后续可以添加业务中间表 jbpm4_biz_tab 有 活动的 主流程 -->
		        and (exists( select p.* from jbpm4_hist_procinst p  where p.state_ = 'active' and p.id_ = t1.execution_id_ 	<!-- 找主流程下所有子流程 包括并发流程/会签  -->
		          			)
		          	<!-- 只有主流程，没有子流程 -->	
		            or exists (select p1.*  from jbpm4_hist_procinst  p1  where p1.state_ = 'active' and p1.main_id_ is null 
					              and instr(t1.execution_id_,p1.id_) >0 /*支持非主子流程的 会签 */ )
		        )

		 		<if test="dto.paramUserId != null and dto.paramUserId != '' " >    
		            and t1.assignee_ ='${dto.paramUserId}'
		        </if>
		        <if test="dto.processParticipationName != null and dto.processParticipationName != ''" >    
		            and t1.assignee_  in (${dto.processParticipationName})
		        </if>
		        <if test="dto.acitityName != null and dto.acitityName != '' and (eqActName == null or eqActName !=1) " >    
		            and t1.activity_name_ like '%'||#{dto.acitityName}||'%'
		        </if>
		        <if test="dto.acitityName != null and dto.acitityName != '' and eqActName == 1 " >    
		            and t1.activity_name_ =#{dto.acitityName}
		        </if>
		         <if test="dto.processInsId != null and dto.processInsId != ''" >    
		            and t1.execution_id_ like '%'||#{dto.processInsId}||'%'
		        </if>
				<if test="dto.processStartDate != null and dto.processStartDate != ''" >    
		            and   <![CDATA[t1.create_ > #{dto.processStartDate}]]>
		        </if>
				<if test="dto.processEndDate != null and dto.processEndDate != ''" >    
		            and   <![CDATA[t1.create_ < #{dto.processEndDate}]]>
		        </if>
				<if test="dto.taskId != null and dto.taskId != ''" >    
		            and  t1.dbid_ = #{dto.taskId} 
		        </if>
				 <if test="dto.startTime != null and dto.startTime != ''" >    
		            and  <![CDATA[  t1.create_ >= to_date(#{dto.startTime},'yyyy-MM-dd') ]]>
		        </if>
		         <if test="dto.endTime != null and dto.endTime != ''" >    
		            and  <![CDATA[  t1.create_ <=  to_date(#{dto.endTime},'yyyy-MM-dd')+1 ]]>
		        </if>
		        <if test="dto.busInfoName != null and dto.busInfoName != '' " >    
		            and exists (select * from jbpm4_biz_tab bt where bt.biz_inf_name like '%'||#{dto.busInfoName}||'%' 
		            	and bt.validate_state='1' 
		            	and bt.pro_instance_id in(
						select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
						from jbpm4_hist_procinst hp where hp.id_=t1.execution_id_
						)
		            )
		        </if>
		        <if test="dto.busInfoId != null and dto.busInfoId != '' " >    
		            and exists (select * from jbpm4_biz_tab bt where bt.biz_inf_id like '%'||#{dto.busInfoId}||'%' 
		            	and bt.validate_state='1' 
		            	and bt.pro_instance_id in(
						select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
						from jbpm4_hist_procinst hp where hp.id_=t1.execution_id_
						)
		            )
		        </if>
		        <if test="dto.bizTaskType != null and dto.bizTaskType != '' " >    
		            and exists (select * from jbpm4_biz_tab bt where bt.biz_task_type =#{dto.bizTaskType}
		            	and bt.validate_state='1' 
		            	and bt.pro_instance_id in(
						select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
						from jbpm4_hist_procinst hp where hp.id_=t1.execution_id_
						)
		            )
		        </if>
		        <if test="dto.remark != null and dto.remark != '' " >    
		            and exists (select * from jbpm4_biz_tab bt where bt.remark like '%'||#{dto.remark}||'%'
		            	and bt.validate_state='1' 
		            	and bt.pro_instance_id in(
						select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
						from jbpm4_hist_procinst hp where hp.id_=t1.execution_id_
						)
		            )
		        </if>
		        <!-- 2014-11-8 13:56:31 chj add 查询 任务类型  -->
		        <if test="dto.bizType != null and dto.bizType != ''">
		        	and exists (select * from jbpm4_biz_tab bt where bt.biz_type =#{dto.bizType}
		            	and bt.validate_state='1' 
		            	and bt.pro_instance_id in(
						select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
						from jbpm4_hist_procinst hp where hp.id_=t1.execution_id_
						)
					)
		        </if>
		        <if test="dto.proStartTime != null and dto.proStartTime != ''">
		        	and exists ( select hp.id_ from jbpm4_hist_procinst hp 
		        				where hp.id_ = t1.execution_id_
								and hp.start_  >= to_date(#{dto.proStartTime},'yyyy-MM-dd')
					)
		        </if>
		        <if test="dto.proEndTime != null and dto.proEndTime != ''">
		        	and exists ( select hp.id_ from jbpm4_hist_procinst hp 
		        				 where hp.id_ = t1.execution_id_
								 and hp.start_  <![CDATA[ <= ]]> to_date(#{dto.proEndTime},'yyyy-MM-dd') +1
					)
		        </if>
		        /*自定义业务表与工作流表关联的sql条件控制*/
		        <if test="myExtSQL != null and myExtSQL != ''">
		        	${myExtSQL}
		        </if>
		        /*自定义工作流 数据权限控制*/
		        <if test="dataCSQL != null and dataCSQL != ''">
		        	${dataCSQL}
		        </if>
		        
		        <if test="dto.customSQL != null and dto.customSQL != '' " >
				order by task_state desc ,biz_task_type,t1.create_ asc
				</if>
				<if test="dto.customSQL == null or dto.customSQL == '' " >
        		order by t1.create_ 	asc
        		</if>
        
        
		) T
		) TEMP
		
			<if test="page != null" >    
	            <![CDATA[WHERE TEMP.NUM > #{page.startIndex} and TEMP.NUM <= (#{page.startIndex} + #{page.pageSize})]]>
	        </if>
	</select>
<!-- 查询待办任务 不 支持主子流程、会签流程 -->
<select id="queryTasksByMySql" parameterType="java.util.Map" resultType="java.util.Map">
	SELECT TEMP.* FROM (
    select  ROWNUM NUM,
    T.*,
    count(1) over() totalRecordNum
    	from(
		        select 
		        t1.dbid_				taskId
		        ,t1.ACTIVITY_NAME_		cur_act_name
		        ,t1.EXECUTION_ID_		cur_exe_id
		        ,t1.lock_state
		        ,t1.ASSIGNEE_ 			cur_owner
		        ,to_char(t1.create_,'YYYY-MM-DD HH24:MI:SS') start_time
		        ,(select p.main_id_ from jbpm4_hist_procinst p where p.dbid_ = t1.procinst_ ) main_id
		        
		        <!-- 如果是自定义sql则展示 -->
		        <if test="dto.customSQL != null and dto.customSQL != '' " >    
	            ,(select b.biz_task_type from jbpm4_biz_tab b where b.pro_instance_id = t1.execution_id_) biz_task_type
	            ,(select case when b.task_state is null then '0' else b.task_state end from jbpm4_biz_tab b where b.pro_instance_id = t1.execution_id_) task_state
		        </if>
		        
		        <if test="dto.extSort != null and dto.extSort != '' " >    
	            ,(select b.ext1 from jbpm4_biz_tab b where b.pro_instance_id = t1.execution_id_) ext1
	            ,(select b.ext2 from jbpm4_biz_tab b where b.pro_instance_id = t1.execution_id_) ext2
	            ,(select b.ext3 from jbpm4_biz_tab b where b.pro_instance_id = t1.execution_id_) ext3
		        </if>
		        
		        from jbpm4_task            t1 
		        where 1 = 1 
		        and t1.state_  is not null
		        
		 		<if test="dto.paramUserId != null and dto.paramUserId != '' " >    
		            and t1.assignee_ ='${dto.paramUserId}'
		        </if>
		        <if test="dto.paramUserIds != null and dto.paramUserIds != '' " >    
		            and t1.assignee_ in ${dto.paramUserIds}
		        </if>
		        <if test="dto.processParticipationName != null and dto.processParticipationName != ''" >    
		            and t1.assignee_  in (${dto.processParticipationName})
		        </if>
		        <if test="dto.acitityName != null and dto.acitityName != '' and (eqActName == null or eqActName !=1) " >    
		            and t1.activity_name_ like '%'||#{dto.acitityName}||'%'
		        </if>
		        <if test="dto.acitityName != null and dto.acitityName != '' and eqActName == 1 " >    
		            and t1.activity_name_ =#{dto.acitityName}
		        </if>
		         <if test="dto.processInsId != null and dto.processInsId != ''" >    
		            and t1.execution_id_ like '%'||#{dto.processInsId}||'%'
		        </if>
				<if test="dto.processStartDate != null and dto.processStartDate != ''" >    
		            and   <![CDATA[t1.create_ > #{dto.processStartDate}]]>
		        </if>
				<if test="dto.processEndDate != null and dto.processEndDate != ''" >    
		            and   <![CDATA[t1.create_ < #{dto.processEndDate}]]>
		        </if>
				<if test="dto.taskId != null and dto.taskId != ''" >    
		            and  t1.dbid_ = #{dto.taskId} 
		        </if>
				 <if test="dto.startTime != null and dto.startTime != ''" >    
		            and  <![CDATA[  t1.create_ >= to_date(#{dto.startTime},'yyyy-MM-dd') ]]>
		        </if>
		         <if test="dto.endTime != null and dto.endTime != ''" >    
		            and  <![CDATA[  t1.create_ <=  to_date(#{dto.endTime},'yyyy-MM-dd')+1 ]]>
		        </if>
		        <if test="dto.busInfoName != null and dto.busInfoName != '' " >    
		            and exists (select * from jbpm4_biz_tab bt where bt.biz_inf_name like '%'||#{dto.busInfoName}||'%' 
		            	and bt.validate_state='1' 
		            	and bt.pro_instance_id in(
						select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
						from jbpm4_hist_procinst hp where hp.dbid_=t1.procinst_
						)
		            )
		        </if>
		        <if test="dto.busInfoId != null and dto.busInfoId != '' " >    
		            and exists (select * from jbpm4_biz_tab bt where bt.biz_inf_id like '%'||#{dto.busInfoId}||'%' 
		            	and bt.validate_state='1' 
		            	and bt.pro_instance_id in(
						select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
						from jbpm4_hist_procinst hp where hp.dbid_=t1.procinst_
						)
		            )
		        </if>
		        <if test="dto.bizTaskType != null and dto.bizTaskType != '' " >    
		            and exists (select * from jbpm4_biz_tab bt where bt.biz_task_type =#{dto.bizTaskType}
		            	and bt.validate_state='1' 
		            	and bt.pro_instance_id in(
						select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
						from jbpm4_hist_procinst hp where hp.dbid_=t1.procinst_
						)
		            )
		        </if>
		        <if test="dto.remark != null and dto.remark != '' " >    
		            and exists (select * from jbpm4_biz_tab bt where bt.remark like '%'||#{dto.remark}||'%'
		            	and bt.validate_state='1' 
		            	and bt.pro_instance_id in(
						select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
						from jbpm4_hist_procinst hp where hp.dbid_=t1.procinst_
						)
		            )
		        </if>
		        <!-- 2014-11-8 13:56:31 chj add 查询 任务类型  -->
		        <if test="dto.bizType != null and dto.bizType != ''">
		        	and exists (select * from jbpm4_biz_tab bt where bt.biz_type =#{dto.bizType}
		            	and bt.validate_state='1' 
		            	and bt.pro_instance_id in(
						select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
						from jbpm4_hist_procinst hp where hp.dbid_=t1.procinst_
						)
					)
		        </if>
		        <if test="dto.proStartTime != null and dto.proStartTime != ''">
		        	and exists ( select hp.id_ from jbpm4_hist_procinst hp 
		        				where hp.id_ = t1.execution_id_
								and hp.start_  >= to_date(#{dto.proStartTime},'yyyy-MM-dd')
					)
		        </if>
		        <if test="dto.proEndTime != null and dto.proEndTime != ''">
		        	and exists ( select hp.id_ from jbpm4_hist_procinst hp 
		        				 where hp.id_ = t1.execution_id_
								 and hp.start_  <![CDATA[ <= ]]> to_date(#{dto.proEndTime},'yyyy-MM-dd') +1
					)
		        </if>
			 <!-- 2015-5-14 查询组织机构 -->
		        <if test="dto.orgId != null and dto.orgId != ''">
		        	and exists (select * from jbpm4_biz_tab bt where bt.org_id =#{dto.orgId}
		            	and bt.validate_state='1' 
		            	and bt.pro_instance_id in(
						select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
						from jbpm4_hist_procinst hp where hp.dbid_=t1.procinst_
						)
					)
		        </if>
		        /*自定义业务表与工作流表关联的sql条件控制*/
		        <if test="myExtSQL != null and myExtSQL != ''">
		        	${myExtSQL}
		        </if>
		        /*自定义工作流 数据权限控制*/
		        <if test="dataCSQL != null and dataCSQL != ''">
		        	${dataCSQL}
		        </if>
		        /*角色映射权限控制*/
		        <if test="dto.roleMappingSql != null and dto.roleMappingSql != ''">
		        	${dto.roleMappingSql}
		        </if>
			
		        <if test="dto.customSQL != null and dto.customSQL != '' " >
					order by ${dto.extSort} task_state desc ,biz_task_type,t1.create_ asc
				</if>
				<if test="dto.customSQL == null or dto.customSQL == '' " >
					<if test="dto.sortName==null or dto.sortName==''">
        			  order by t1.create_ 	asc
        			</if>
        		 	<if test="dto.sortName != null and dto.sortName != ''">
		       		  order by ${dto.sortName} ${dto.sortType}
            		</if>
				</if>
		    
		   
        
        
		) T
		) TEMP
		
			<if test="page != null" >    
	            <![CDATA[WHERE TEMP.NUM > #{page.startIndex} and TEMP.NUM <= (#{page.startIndex} + #{page.pageSize})]]>
	        </if>
	</select>
	<!-- 通过平台公共分页 查询待办任务 不 支持主子流程、会签流程 -->
	<select id="queryTasksByMySqlByPaging" parameterType="java.util.Map" resultType="java.util.Map">
		        select 
		        t1.dbid_				taskId
		        ,t1.ACTIVITY_NAME_		cur_act_name
		        ,t1.EXECUTION_ID_		cur_exe_id
		        ,t1.lock_state
		        ,t1.ASSIGNEE_ 			cur_owner
		        ,to_char(t1.create_,'YYYY-MM-DD HH24:MI:SS') start_time
		        ,(select p.main_id_ from jbpm4_hist_procinst p where p.dbid_ = t1.procinst_ ) main_id
		        
		        <!-- 如果是自定义sql则展示 -->
		        <if test="dto.customSQL != null and dto.customSQL != '' " >    
	            ,(select b.biz_task_type from jbpm4_biz_tab b where b.pro_instance_id = t1.execution_id_) biz_task_type
	            ,(select case when b.task_state is null then '0' else b.task_state end from jbpm4_biz_tab b where b.pro_instance_id = t1.execution_id_) task_state
		        </if>
		        
		        <if test="dto.extSort != null and dto.extSort != '' " >    
	            ,(select b.ext1 from jbpm4_biz_tab b where b.pro_instance_id = t1.execution_id_) ext1
	            ,(select b.ext2 from jbpm4_biz_tab b where b.pro_instance_id = t1.execution_id_) ext2
	            ,(select b.ext3 from jbpm4_biz_tab b where b.pro_instance_id = t1.execution_id_) ext3
		        </if>
		        
		        from jbpm4_task            t1 
		        where 1 = 1 
		        and t1.state_  is not null
		        
		 		<if test="dto.paramUserId != null and dto.paramUserId != '' " >    
		            and t1.assignee_ ='${dto.paramUserId}'
		        </if>
		        <if test="dto.paramUserIds != null and dto.paramUserIds != '' " >    
		            and t1.assignee_ in ${dto.paramUserIds}
		        </if>
		        <if test="dto.processParticipationName != null and dto.processParticipationName != ''" >    
		            and t1.assignee_  in (${dto.processParticipationName})
		        </if>
		        <if test="dto.acitityName != null and dto.acitityName != '' and (eqActName == null or eqActName !=1) " >    
		            and t1.activity_name_ like '%'||#{dto.acitityName}||'%'
		        </if>
		        <if test="dto.acitityName != null and dto.acitityName != '' and eqActName == 1 " >    
		            and t1.activity_name_ =#{dto.acitityName}
		        </if>
		         <if test="dto.processInsId != null and dto.processInsId != ''" >    
		            and t1.execution_id_ like '%'||#{dto.processInsId}||'%'
		        </if>
				<if test="dto.processStartDate != null and dto.processStartDate != ''" >    
		            and   <![CDATA[t1.create_ > #{dto.processStartDate}]]>
		        </if>
				<if test="dto.processEndDate != null and dto.processEndDate != ''" >    
		            and   <![CDATA[t1.create_ < #{dto.processEndDate}]]>
		        </if>
				<if test="dto.taskId != null and dto.taskId != ''" >    
		            and  t1.dbid_ = #{dto.taskId} 
		        </if>
				 <if test="dto.startTime != null and dto.startTime != ''" >    
		            and  <![CDATA[  t1.create_ >= to_date(#{dto.startTime},'yyyy-MM-dd') ]]>
		        </if>
		         <if test="dto.endTime != null and dto.endTime != ''" >    
		            and  <![CDATA[  t1.create_ <=  to_date(#{dto.endTime},'yyyy-MM-dd')+1 ]]>
		        </if>
		        <if test="dto.busInfoName != null and dto.busInfoName != '' " >    
		            and exists (select * from jbpm4_biz_tab bt where bt.biz_inf_name like '%'||#{dto.busInfoName}||'%' 
		            	and bt.validate_state='1' 
		            	and bt.pro_instance_id in(
						select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
						from jbpm4_hist_procinst hp where hp.dbid_=t1.procinst_
						)
		            )
		        </if>
		        <if test="dto.busInfoId != null and dto.busInfoId != '' " >    
		            and exists (select * from jbpm4_biz_tab bt where bt.biz_inf_id like '%'||#{dto.busInfoId}||'%' 
		            	and bt.validate_state='1' 
		            	and bt.pro_instance_id in(
						select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
						from jbpm4_hist_procinst hp where hp.dbid_=t1.procinst_
						)
		            )
		        </if>
		        <if test="dto.bizTaskType != null and dto.bizTaskType != '' " >    
		            and exists (select * from jbpm4_biz_tab bt where bt.biz_task_type =#{dto.bizTaskType}
		            	and bt.validate_state='1' 
		            	and bt.pro_instance_id in(
						select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
						from jbpm4_hist_procinst hp where hp.dbid_=t1.procinst_
						)
		            )
		        </if>
		        <if test="dto.remark != null and dto.remark != '' " >    
		            and exists (select * from jbpm4_biz_tab bt where bt.remark like '%'||#{dto.remark}||'%'
		            	and bt.validate_state='1' 
		            	and bt.pro_instance_id in(
						select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
						from jbpm4_hist_procinst hp where hp.dbid_=t1.procinst_
						)
		            )
		        </if>
		        <!-- 2014-11-8 13:56:31 chj add 查询 任务类型  -->
		        <if test="dto.bizType != null and dto.bizType != ''">
		        	and exists (select * from jbpm4_biz_tab bt where bt.biz_type =#{dto.bizType}
		            	and bt.validate_state='1' 
		            	and bt.pro_instance_id in(
						select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
						from jbpm4_hist_procinst hp where hp.dbid_=t1.procinst_
						)
					)
		        </if>
		        <if test="dto.proStartTime != null and dto.proStartTime != ''">
		        	and exists ( select hp.id_ from jbpm4_hist_procinst hp 
		        				where hp.id_ = t1.execution_id_
								and hp.start_  >= to_date(#{dto.proStartTime},'yyyy-MM-dd')
					)
		        </if>
		        <if test="dto.proEndTime != null and dto.proEndTime != ''">
		        	and exists ( select hp.id_ from jbpm4_hist_procinst hp 
		        				 where hp.id_ = t1.execution_id_
								 and hp.start_  <![CDATA[ <= ]]> to_date(#{dto.proEndTime},'yyyy-MM-dd') +1
					)
		        </if>
			 <!-- 2015-5-14 查询组织机构 -->
		        <if test="dto.orgId != null and dto.orgId != ''">
		        	and exists (select * from jbpm4_biz_tab bt where bt.org_id =#{dto.orgId}
		            	and bt.validate_state='1' 
		            	and bt.pro_instance_id in(
						select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
						from jbpm4_hist_procinst hp where hp.dbid_=t1.procinst_
						)
					)
		        </if>
		        /*自定义业务表与工作流表关联的sql条件控制*/
		        <if test="myExtSQL != null and myExtSQL != ''">
		        	${myExtSQL}
		        </if>
		        /*自定义工作流 数据权限控制*/
		        <if test="dataCSQL != null and dataCSQL != ''">
		        	${dataCSQL}
		        </if>
		        /*角色映射权限控制*/
		        <if test="dto.roleMappingSql != null and dto.roleMappingSql != ''">
		        	${dto.roleMappingSql}
		        </if>
			
		        <if test="dto.customSQL != null and dto.customSQL != '' " >
					order by ${dto.extSort} task_state desc ,biz_task_type,t1.create_ asc
				</if>
				
				<if test="dto.customSQL == null or dto.customSQL == '' " >
					<if test="dto.sortName==null or dto.sortName==''">
        			  order by t1.create_ 	asc
        			</if>
        		 	<if test="dto.sortName != null and dto.sortName != ''">
		       		  order by ${dto.sortName} ${dto.sortType}
            		</if>
				</if>
	</select>
	
	<!-- 获取 上一节点的处理人信息 -->
  <select id="getUpTaskDealPersonInfo" parameterType="java.util.HashMap" resultType="java.util.HashMap" >
	select 
			ht1.assignee_  up_user_id
	from jbpm4_hist_task ht1
		where 1 = 1
		and ht1.dbid_= (select max(ht.dbid_) 
		  from jbpm4_hist_task ht 
		  where 1 = 1
		  and ht.state_='completed'
		  
		<if test="executionId != null and executionId !='' " >    
	      and ht.execution_=#{executionId}
        </if>
		<if test="mainProInsId != null and mainProInsId !='' " >    
	      and ht.execution_=#{mainProInsId}
        </if>
		)
  </select>
  
  <!-- 获取 任务的业务关联表信息 -->
  <select id="obtainBizTabInfo" parameterType="java.util.HashMap" resultType="java.util.HashMap" >
			select
				bt.id	biz_tab_id 
			   ,bt.biz_tab_name
		       ,bt.biz_inf_id
		       ,bt.biz_inf_no
		       ,bt.biz_inf_name
		       ,bt.biz_task_type
		       ,bt.biz_type
		       ,bt.task_state
		       ,bt.pro_instance_state
		       ,bt.pro_instance_id
		       ,bt.start_pro_userid
		       ,to_char(bt.create_time,'YYYY-MM-DD HH24:MI:SS') 				start_pro_time
		       ,bt.remark					pro_remark
		       ,(select to_char(hp.start_ ,'YYYY-MM-DD HH24:MI:SS')  from jbpm4_hist_procinst hp where hp.id_= bt.pro_instance_id ) start_ins_time
		       
		from jbpm4_biz_tab bt 
		where bt.validate_state = '1'
		and bt.pro_instance_id=#{mainProInsId}
  </select>
  
  <!-- 获取 表单配置信息 -->
  <select id="obtainJbpm4FormInfo" parameterType="java.util.HashMap" resultType="java.util.HashMap" >
			select 
			      f.pro_activity_form
			      ,f.participator_type		participant_type
			      ,f.rule_info				participant_rule
			      ,f.other_params			other_params
			      ,to_char(f.id)			form_id
			      ,f.part_type				part_type
			      ,f.pro_activity_name		pro_activity_name
			from jbpm4_form_info f
			where f.validate_state='1'
			and f.pro_def_key=#{proDefKey}
			and f.pro_level=#{proDefVersion}
			and f.pro_activity_name=#{proActName}
  </select>
  <!-- 通过主键ID 获取 表单配置信息  -->
  <select id="obtainJbpm4FormInfoById" parameterType="java.util.HashMap" resultType="java.util.HashMap" >
			select 
			      f.pro_activity_form
			      ,f.participator_type		participant_type
			      ,f.rule_info				participant_rule
			      ,f.other_params			other_params
			      ,to_char(f.id)			form_id
			      ,f.part_type				part_type
			      ,f.pro_activity_name		pro_activity_name
			from jbpm4_form_info f
			where f.validate_state='1'
			and f.id=#{formId}
  </select>
	<!--jbpm4.4 自定义 已经处理的任务 查询 修改后可以查询 主流程下 所有子流程 信息 2 temp-->
<select id="queryCompletedTasksByMySql2Temp" parameterType="java.util.HashMap" resultType="java.util.HashMap">
	SELECT TEMP.* FROM (
    select  ROWNUM NUM,
    T.*,
    count(1) over() totalRecordNum
    	from(
		select 
		       	t2.dbid_
				,t1.main_id_
				,t2.dbversion_
				,t2.execution_
				,t2.outcome_
				,t2.assignee_
				,'realNameOfTask' 								realNameOfTask
				,t1.dbid_               						pro_ins_id
				,to_char(t3.start_ ,'YYYY-MM-DD HH24:MI:SS')  	start_
				,to_char(t3.end_ ,'YYYY-MM-DD HH24:MI:SS')    	end_
				,t3.activity_name_           											
				,t4.activity_name_       						current_ac_name
				,t4.assignee_									taskAssignee
				,'realNameOfCurTask' 							realNameOfCurTask
				,t4.DBID_              							taskId
				,t5.biz_tab_name          
				,t5.biz_inf_id            
				,t5.biz_inf_name          
				,t5.pro_instance_id       
				,t5.task_state            
				,t5.pro_instance_state		
				,t5.biz_type		  
		         from 
		             jbpm4_hist_procinst      t1,
		             jbpm4_hist_task          t2,
		             jbpm4_hist_actinst       t3,
		             jbpm4_task               t4,
		             jbpm4_biz_tab       	  t5
		             
				where t1.state_='active'
				and t2.state_ is null
				and t1.id_ = t2.execution_
				and t2.dbid_ = t3.htask_
				and t1.main_id_ in (select t1.main_id_ from jbpm4_hist_procinst t1 where t1.main_id_ like '%${dto.mainProInsId}%')
				and t2.execution_ = t4.execution_id_(+)
				and (t2.outcome_ is null or t2.outcome_ not like 'regect%')
				and t5.pro_instance_id='${dto.mainProInsId}'
    
   		<if test="dto.paramUserId != null" >    
   				and substr(t1.main_id_ ,0,length(t5.pro_instance_id)) in 
                ( select substr(t10.main_id_,0,length(t5.pro_instance_id)) main_id_ 
                		from jbpm4_hist_procinst t10 
                		where t10.main_id_ is not null
                 		and  t10.id_ in(select distinct t9.execution_ from jbpm4_hist_task t9 where t9.assignee_= #{dto.paramUserId})
                )
               
                and t2.end_ is null
   		</if>
   		
        	order by t2.end_ desc
		) T
		) TEMP
		
		<if test="page != null" >    
            <![CDATA[
            WHERE TEMP.NUM >  #{page.startIndex} AND TEMP.NUM <= #{page.startIndex} + #{page.pageSize}
            ]]>
        </if>
</select>
<!-- 查询个人已办任务信息 -->
<select id="queryCompletedTasksByMySql_1" parameterType="java.util.HashMap" resultType="java.util.HashMap">
	SELECT TEMP.* FROM (
    select  ROWNUM NUM,
    T.*,
    count(1) over() totalRecordNum
    	from(
			select 
			     t.dbid_			taskId
			    ,case when (select hp1.main_id_ from jbpm4_hist_procinst hp1 where hp1.id_ = t.execution_)  is not null 
                 then (select hp2.id_ from jbpm4_hist_procinst hp2 
                       where hp2.dbid_ = (select max(hp.dbid_) from jbpm4_hist_procinst hp where hp.main_id_=(select hp1.main_id_ from jbpm4_hist_procinst hp1 where hp1.id_ = t.execution_)
                                         )
                       )
                 else   t.execution_   
                 end 	cur_exe_id
			    ,t.assignee_		cur_owner
			    ,to_char(t.create_ ,'YYYY-MM-DD HH24:MI:SS')			create_time
			    ,to_char(t.end_ ,'YYYY-MM-DD HH24:MI:SS')				end_time
			    ,(select t2.activity_name_ from jbpm4_task t2 where t2.execution_id_=t.execution_)	cur_act_name
			    ,(select P1.main_id_ from jbpm4_hist_procinst p1 where p1.id_=t.execution_)			main_id
			    ,(select a.activity_name_  from jbpm4_hist_actinst a   where a.htask_=t.dbid_)		his_act_name
			from jbpm4_hist_task t
			where t.state_='completed'
			/*过滤主动收回任务*/
			and (instr(t.OUTCOME_, 'regect') = 0 or t.OUTCOME_ is null)
			<if test="dto.paramUserId != null and dto.paramUserId != '' " >
			and t.assignee_='${dto.paramUserId}'
			</if>
			/*主子流程时 已办任务流程实例ID 需判断 最大*/
			 and exists (select hp.* from jbpm4_hist_procinst hp where  hp.id_ = t.execution_
                         and hp.dbid_ in ( select max(tt.dbid_) from (select  hp.dbid_ ,hp.id_ ,case when hp.main_id_ is not null then hp.main_id_  else hp.id_ end  main_id
                                          from jbpm4_hist_procinst hp where hp.state_='active')tt group by tt.main_id
                         				  ) 
           	 			)
           	 			
			and (
			/*其流程实例 或会签流程 是活动的*/
			exists ( select p.id_ from jbpm4_hist_procinst p  where p.end_ is null   and p.state_='active' and instr(t.execution_,p.id_)> 0) 
			/*或者 其主流程实例 是活动的*/
			or exists (select P1.* from jbpm4_hist_procinst p1 where p1.end_ is null and p1.state_='active' 
			and p1.id_ = (select p.main_id_ from jbpm4_hist_procinst p  where p.end_ is null   and p.state_='active' and p.id_ = t.execution_)
			           )
			)
			<if test="dto.processInsId!=null and dto.processInsId!=''">
				and t.execution_=#{dto.processInsId}
			</if>
			<if test="dto.startTime != null and dto.startTime != ''" >    
		        and  <![CDATA[  t.end_ >= to_date(#{dto.startTime},'yyyy-MM-dd') ]]>
	        </if>
	        <if test="dto.endTime != null and dto.endTime != ''" >    
	            and  <![CDATA[  t.end_ <=  to_date(#{dto.endTime},'yyyy-MM-dd')+1 ]]>
	        </if>
			<if test="dto.busInfoName != null and dto.busInfoName != '' " >    
		            and exists (select * from jbpm4_biz_tab bt where bt.biz_inf_name like '%'||#{dto.busInfoName}||'%' 
		            	and bt.validate_state='1' 
		            	and bt.pro_instance_id in(
						select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
						from jbpm4_hist_procinst hp where hp.id_=t.execution_
						)
		            )
	        </if>
	        <if test="dto.busInfoId != null and dto.busInfoId != '' " >    
	            and exists (select * from jbpm4_biz_tab bt where bt.biz_inf_id like '%'||#{dto.busInfoId}||'%' 
	            	and bt.validate_state='1' 
	            	and bt.pro_instance_id in(
					select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
					from jbpm4_hist_procinst hp where hp.id_=t.execution_
					)
	            )
	        </if>
	        <if test="dto.bizTaskType != null and dto.bizTaskType != '' " >    
	            and exists (select * from jbpm4_biz_tab bt where bt.biz_task_type =#{dto.bizTaskType}
	            	and bt.validate_state='1' 
	            	and bt.pro_instance_id in(
					select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
					from jbpm4_hist_procinst hp where hp.id_=t.execution_
					)
	            )
	        </if>
	        <if test="dto.remark != null and dto.remark != '' " >    
	            and exists (select * from jbpm4_biz_tab bt where bt.remark like '%'||#{dto.remark}||'%'
	            	and bt.validate_state='1' 
	            	and bt.pro_instance_id in(
					select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
					from jbpm4_hist_procinst hp where hp.id_=t.execution_
					)
	            )
	        </if>
	        <!-- 2014-11-8 13:56:31 chj add 查询 任务类型  -->
	        <if test="dto.bizType != null and dto.bizType != ''">
	        	and exists (select * from jbpm4_biz_tab bt where bt.biz_type =#{dto.bizType}
	            	and bt.validate_state='1' 
	            	and bt.pro_instance_id in(
					select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
					from jbpm4_hist_procinst hp where hp.id_=t.execution_)
				)
	        </if>
	        <if test="dto.proStartTime != null and dto.proStartTime != ''">
		        	and exists ( select hp.id_ from jbpm4_hist_procinst hp 
		        				where hp.id_ = t.execution_
								and hp.start_  >= to_date(#{dto.proStartTime},'yyyy-MM-dd')
					)
	        </if>
	        <if test="dto.proEndTime != null and dto.proEndTime != ''">
	        	and exists ( select hp.id_ from jbpm4_hist_procinst hp 
	        				 where hp.id_ = t.execution_
							 and hp.start_  <![CDATA[ <= ]]> to_date(#{dto.proEndTime},'yyyy-MM-dd') +1
				)
	        </if>
	        /*自定义工作流 数据权限控制*/
	        <if test="dataCSQL != null and dataCSQL != ''">
	        	${dataCSQL}
	        </if>
			order by t.end_ desc
		) T
		) TEMP
		
		<if test="page != null" >    
            <![CDATA[
            WHERE TEMP.NUM >  #{page.startIndex} AND TEMP.NUM <= #{page.startIndex} + #{page.pageSize}
            ]]>
        </if>
</select>
<!-- 查询个人已办任务信息 支持会签流程 -->
<select id="queryCompletedTasksByMySql_hq" parameterType="java.util.HashMap" resultType="java.util.HashMap">
	SELECT TEMP.* FROM (
    select  ROWNUM NUM,
    T.*,
    count(1) over() totalRecordNum
    	from(
			select 
           t.dbid_      taskId
          ,(select p.id_ from jbpm4_hist_procinst p where instr(t.execution_,p.id_)>0) cur_exe_id
          ,t.assignee_    cur_owner
          ,to_char(t.create_ ,'YYYY-MM-DD HH24:MI:SS')      create_time
          ,to_char(t.end_ ,'YYYY-MM-DD HH24:MI:SS')        end_time
          ,(select max(t2.activity_name_) from jbpm4_task t2,jbpm4_execution e where t2.procinst_=e.instance_ and e.id_=t.execution_) 
           ||
           (select t2.activity_name_ from jbpm4_task t2 where t2.execution_id_ = (select p1.main_id_
                          from jbpm4_hist_procinst p1
                         where instr(t.execution_, p1.id_) > 0))cur_act_name
          ,(select p1.main_id_ from jbpm4_hist_procinst p1 where instr(t.execution_,p1.id_)>0)  main_id
          ,(select a.activity_name_  from jbpm4_hist_actinst a   where a.htask_=t.dbid_)    his_act_name
	      from jbpm4_hist_task t
	      where t.end_ is not null
	      /*过滤主动收回任务*/
	      and (instr(t.OUTCOME_, 'regect') = 0 or t.OUTCOME_ is null)
	      <if test="dto.paramUserId != null and dto.paramUserId != '' " >
	      	  and t.assignee_='${dto.paramUserId}'
	      </if>
	      <if test="dto.processParticipationName != null and dto.processParticipationName != ''" >    
	          and t.assignee_  in (${dto.processParticipationName})
	      </if>
	       /*其流程实例  是活动的*/      
	        and  (exists (select p.id_ from jbpm4_hist_procinst p where instr(t.execution_,p.id_)>0 and p.end_ is null)
	         or exists (select p1.id_ from jbpm4_hist_procinst p1 where p1.id_ in (select p.main_id_ from jbpm4_hist_procinst p where instr(t.execution_,p.id_)>0) and p1.end_ is null)
	        )
	      <if test="dto.processInsId!=null and dto.processInsId!=''">
	        and t.execution_=#{dto.processInsId}
	      </if>
	      <if test="dto.startTime != null and dto.startTime != ''" >    
	         and  <![CDATA[  t.end_ >= to_date(#{dto.startTime},'yyyy-MM-dd') ]]>
	      </if>
          <if test="dto.endTime != null and dto.endTime != ''" >    
              and  <![CDATA[  t.end_ <=  to_date(#{dto.endTime},'yyyy-MM-dd')+1 ]]>
          </if>
	      <if test="dto.busInfoName != null and dto.busInfoName != '' " >    
               and exists (select * from jbpm4_biz_tab bt where bt.biz_inf_name like '%'||#{dto.busInfoName}||'%' 
                 and bt.validate_state='1' 
                 and bt.pro_instance_id in(
	            select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
	            from jbpm4_hist_procinst hp where instr(t.execution_,hp.id_)>0
	            )
               )
          </if>
          <if test="dto.busInfoId != null and dto.busInfoId != '' " >    
              and exists (select * from jbpm4_biz_tab bt where bt.biz_inf_id like '%'||#{dto.busInfoId}||'%' 
	              and bt.validate_state='1' 
	              and bt.pro_instance_id in(
			          select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
			          from jbpm4_hist_procinst hp where instr(t.execution_,hp.id_)>0
	          		)
	              )
	      </if>
          <if test="dto.bizTaskType != null and dto.bizTaskType != '' " >    
              and exists (select * from jbpm4_biz_tab bt where bt.biz_task_type =#{dto.bizTaskType}
                and bt.validate_state='1' 
                and bt.pro_instance_id in(
		          select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
		          from jbpm4_hist_procinst hp where instr(t.execution_,hp.id_)>0
		          )
              )
          </if>
          <if test="dto.remark != null and dto.remark != '' " >    
              and exists (select * from jbpm4_biz_tab bt where bt.remark like '%'||#{dto.remark}||'%'
                and bt.validate_state='1' 
                and bt.pro_instance_id in(
		          select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
		          from jbpm4_hist_procinst hp where instr(t.execution_,hp.id_)>0
		          )
              )
          </if>
          <!-- 2014-11-8 13:56:31 chj add 查询 任务类型  -->
          <if test="dto.bizType != null and dto.bizType != ''">
	            and exists (select * from jbpm4_biz_tab bt where bt.biz_type =#{dto.bizType}
	                and bt.validate_state='1' 
	                and bt.pro_instance_id in(
			          select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
			          from jbpm4_hist_procinst hp where instr(t.execution_,hp.id_)>0)
			        )
	      </if>
          <if test="dto.proStartTime != null and dto.proStartTime != ''">
              and exists ( select hp.id_ from jbpm4_hist_procinst hp 
                    where instr(t.execution_,hp.id_)>0
                and hp.start_  >= to_date(#{dto.proStartTime},'yyyy-MM-dd')
          		)
          </if>
	      <if test="dto.proEndTime != null and dto.proEndTime != ''">
	            and exists ( select hp.id_ from jbpm4_hist_procinst hp 
	                   where instr(t.execution_,hp.id_)>0
	               and hp.start_  <![CDATA[ <= ]]> to_date(#{dto.proEndTime},'yyyy-MM-dd') +1
	        )
          </if>
          <if test="dto.acitityName != null and dto.acitityName != '' and (eqActName == null or eqActName !=1) " >    
                and (exists 
                 	 (select 1  from jbpm4_task t2, jbpm4_execution e
                      where t2.procinst_ = e.instance_
                           and e.id_ = t.execution_
                           and t2.activity_name_ like '%'||#{dto.acitityName}||'%'                     
                           )
                     or exists
                       (select 1
                          from jbpm4_task t2
                         where t2.execution_id_ =
                               (select p1.main_id_
                                  from jbpm4_hist_procinst p1
                                 where instr(t.execution_, p1.id_) > 0) and t2.activity_name_ like'%'||#{dto.acitityName}||'%'
                           )
                     )  
          </if>
          <if test="dto.acitityName != null and dto.acitityName != '' and eqActName == 1 " > 
              and (exists 
          	 (select 1  from jbpm4_task t2, jbpm4_execution e
               where t2.procinst_ = e.instance_
                    and e.id_ = t.execution_
                    and t2.activity_name_ =#{dto.acitityName}                 
                    )
              or exists
                (select 1
                   from jbpm4_task t2
                  where t2.execution_id_ =
                        (select p1.main_id_
                           from jbpm4_hist_procinst p1
                          where instr(t.execution_, p1.id_) > 0) and t2.activity_name_ =#{dto.acitityName}
                    )
              )  
          </if>
          /*自定义工作流 数据权限控制*/
          <if test="dataCSQL != null and dataCSQL != ''">
            	${dataCSQL}
          </if>
          /*角色映射权限控制*/
          <if test="dto.roleMappingSql != null and dto.roleMappingSql != ''">
           	 	${dto.roleMappingSql}
          </if>
	      order by t.end_ desc
		) T
		) TEMP
		
		<if test="page != null" >    
            <![CDATA[
            WHERE TEMP.NUM >  #{page.startIndex} AND TEMP.NUM <= #{page.startIndex} + #{page.pageSize}
            ]]>
        </if>
</select>

<!-- 查询个人已办任务信息 不支持 主子流程 会签流程 -->
<select id="queryCompletedTasksByMySql" parameterType="java.util.HashMap" resultType="java.util.HashMap">
	SELECT TEMP.* FROM (
    select  ROWNUM NUM,
    T.*,
    count(1) over() totalRecordNum
    	from(
			select 
			     t.dbid_			taskId
			    ,case when (select hp1.main_id_ from jbpm4_hist_procinst hp1 where hp1.id_ = t.execution_)  is not null 
                 then (select hp2.id_ from jbpm4_hist_procinst hp2 
                       where hp2.dbid_ = (select max(hp.dbid_) from jbpm4_hist_procinst hp where hp.main_id_=(select hp1.main_id_ from jbpm4_hist_procinst hp1 where hp1.id_ = t.execution_)
                                         )
                       )
                 else   t.execution_   
                 end 	cur_exe_id
			    ,t.assignee_		cur_owner
			    ,to_char(t.create_ ,'YYYY-MM-DD HH24:MI:SS')			create_time
			    ,to_char(t.end_ ,'YYYY-MM-DD HH24:MI:SS')				end_time
			    ,(select t2.activity_name_ from jbpm4_task t2 where t2.execution_id_=t.execution_)	cur_act_name
			    ,(select P1.main_id_ from jbpm4_hist_procinst p1 where p1.id_=t.execution_)			main_id
			    ,(select a.activity_name_  from jbpm4_hist_actinst a   where a.htask_=t.dbid_)		his_act_name
			from jbpm4_hist_task t
			where t.end_ is not null
			/*过滤主动收回任务*/
			and (instr(t.OUTCOME_, 'regect') = 0 or t.OUTCOME_ is null)
			<if test="dto.paramUserId != null and dto.paramUserId != '' " >
			and t.assignee_='${dto.paramUserId}'
			</if>
		 	<if test="dto.processParticipationName != null and dto.processParticipationName != ''" >    
	            and t.assignee_  in (${dto.processParticipationName})
	        </if>
           	 /*其流程实例  是活动的*/			
			and  exists ( select p.id_ from jbpm4_hist_procinst p  where p.end_ is null  and p.id_ = t.execution_ ) 
			<if test="dto.processInsId!=null and dto.processInsId!=''">
				and t.execution_=#{dto.processInsId}
			</if>
			<if test="dto.startTime != null and dto.startTime != ''" >    
		        and  <![CDATA[  t.end_ >= to_date(#{dto.startTime},'yyyy-MM-dd') ]]>
	        </if>
	        <if test="dto.endTime != null and dto.endTime != ''" >    
	            and  <![CDATA[  t.end_ <=  to_date(#{dto.endTime},'yyyy-MM-dd')+1 ]]>
	        </if>
			<if test="dto.busInfoName != null and dto.busInfoName != '' " >    
		            and exists (select * from jbpm4_biz_tab bt where bt.biz_inf_name like '%'||#{dto.busInfoName}||'%' 
		            	and bt.validate_state='1' 
		            	and bt.pro_instance_id in(
						select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
						from jbpm4_hist_procinst hp where hp.id_=t.execution_
						)
		            )
	        </if>
	        <if test="dto.busInfoId != null and dto.busInfoId != '' " >    
	            and exists (select * from jbpm4_biz_tab bt where bt.biz_inf_id like '%'||#{dto.busInfoId}||'%' 
	            	and bt.validate_state='1' 
	            	and bt.pro_instance_id in(
					select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
					from jbpm4_hist_procinst hp where hp.id_=t.execution_
					)
	            )
	        </if>
	        <if test="dto.bizTaskType != null and dto.bizTaskType != '' " >    
	            and exists (select * from jbpm4_biz_tab bt where bt.biz_task_type =#{dto.bizTaskType}
	            	and bt.validate_state='1' 
	            	and bt.pro_instance_id in(
					select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
					from jbpm4_hist_procinst hp where hp.id_=t.execution_
					)
	            )
	        </if>
	        <if test="dto.remark != null and dto.remark != '' " >    
	            and exists (select * from jbpm4_biz_tab bt where bt.remark like '%'||#{dto.remark}||'%'
	            	and bt.validate_state='1' 
	            	and bt.pro_instance_id in(
					select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
					from jbpm4_hist_procinst hp where hp.id_=t.execution_
					)
	            )
	        </if>
	        <!-- 2014-11-8 13:56:31 chj add 查询 任务类型  -->
	        <if test="dto.bizType != null and dto.bizType != ''">
	        	and exists (select * from jbpm4_biz_tab bt where bt.biz_type =#{dto.bizType}
	            	and bt.validate_state='1' 
	            	and bt.pro_instance_id in(
					select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
					from jbpm4_hist_procinst hp where hp.id_=t.execution_)
				)
	        </if>
	        <if test="dto.proStartTime != null and dto.proStartTime != ''">
		        	and exists ( select hp.id_ from jbpm4_hist_procinst hp 
		        				where hp.id_ = t.execution_
								and hp.start_  >= to_date(#{dto.proStartTime},'yyyy-MM-dd')
					)
	        </if>
	        <if test="dto.proEndTime != null and dto.proEndTime != ''">
	        	and exists ( select hp.id_ from jbpm4_hist_procinst hp 
	        				 where hp.id_ = t.execution_
							 and hp.start_  <![CDATA[ <= ]]> to_date(#{dto.proEndTime},'yyyy-MM-dd') +1
				)
	        </if>
	        <if test="dto.acitityName != null and dto.acitityName != '' and (eqActName == null or eqActName !=1) " >    
		           and exists (select 1
					          from jbpm4_task t2
						      where t2.execution_id_ = t.execution_
						           and t2.activity_name_ like '%'||#{dto.acitityName}||'%'
					           )
	        </if>
	        <if test="dto.acitityName != null and dto.acitityName != '' and eqActName == 1 " >    
	            and exists (select 1
					          from jbpm4_task t2
						      where t2.execution_id_ = t.execution_
						           and t2.activity_name_ =#{dto.acitityName}
					           )
	        </if>
	        /*自定义工作流 数据权限控制*/
	        <if test="dataCSQL != null and dataCSQL != ''">
	        	${dataCSQL}
	        </if>
	        /*角色映射权限控制*/
	        <if test="dto.roleMappingSql != null and dto.roleMappingSql != ''">
	        	${dto.roleMappingSql}
	        </if>
			order by t.end_ desc
		) T
		) TEMP
		
		<if test="page != null" >    
            <![CDATA[
            WHERE TEMP.NUM >  #{page.startIndex} AND TEMP.NUM <= #{page.startIndex} + #{page.pageSize}
            ]]>
        </if>
</select>
<!-- 通过平台公共分页 查询个人已办任务信息 不支持 主子流程 会签流程 -->
<select id="queryCompletedTasksByMySqlByPaging" parameterType="java.util.HashMap" resultType="java.util.HashMap">
			select 
			     t.dbid_			taskId
			    ,case when (select hp1.main_id_ from jbpm4_hist_procinst hp1 where hp1.id_ = t.execution_)  is not null 
                 then (select hp2.id_ from jbpm4_hist_procinst hp2 
                       where hp2.dbid_ = (select max(hp.dbid_) from jbpm4_hist_procinst hp where hp.main_id_=(select hp1.main_id_ from jbpm4_hist_procinst hp1 where hp1.id_ = t.execution_)
                                         )
                       )
                 else   t.execution_   
                 end 	cur_exe_id
			    ,t.assignee_		cur_owner
			    ,to_char(t.create_ ,'YYYY-MM-DD HH24:MI:SS')			create_time
			    ,to_char(t.end_ ,'YYYY-MM-DD HH24:MI:SS')				end_time
			    ,(select t2.activity_name_ from jbpm4_task t2 where t2.execution_id_=t.execution_)	cur_act_name
			    ,(select P1.main_id_ from jbpm4_hist_procinst p1 where p1.id_=t.execution_)			main_id
			    ,(select a.activity_name_  from jbpm4_hist_actinst a   where a.htask_=t.dbid_)		his_act_name
			from jbpm4_hist_task t
			where t.end_ is not null
			/*过滤主动收回任务*/
			and (instr(t.OUTCOME_, 'regect') = 0 or t.OUTCOME_ is null)
			<if test="dto.paramUserId != null and dto.paramUserId != '' " >
			and t.assignee_='${dto.paramUserId}'
			</if>
		 	<if test="dto.processParticipationName != null and dto.processParticipationName != ''" >    
	            and t.assignee_  in (${dto.processParticipationName})
	        </if>
           	 /*其流程实例  是活动的*/			
			and  exists ( select p.id_ from jbpm4_hist_procinst p  where p.end_ is null  and p.id_ = t.execution_ ) 
			<if test="dto.processInsId!=null and dto.processInsId!=''">
				and t.execution_=#{dto.processInsId}
			</if>
			<if test="dto.startTime != null and dto.startTime != ''" >    
		        and  <![CDATA[  t.end_ >= to_date(#{dto.startTime},'yyyy-MM-dd') ]]>
	        </if>
	        <if test="dto.endTime != null and dto.endTime != ''" >    
	            and  <![CDATA[  t.end_ <=  to_date(#{dto.endTime},'yyyy-MM-dd')+1 ]]>
	        </if>
			<if test="dto.busInfoName != null and dto.busInfoName != '' " >    
		            and exists (select * from jbpm4_biz_tab bt where bt.biz_inf_name like '%'||#{dto.busInfoName}||'%' 
		            	and bt.validate_state='1' 
		            	and bt.pro_instance_id in(
						select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
						from jbpm4_hist_procinst hp where hp.id_=t.execution_
						)
		            )
	        </if>
	        <if test="dto.busInfoId != null and dto.busInfoId != '' " >    
	            and exists (select * from jbpm4_biz_tab bt where bt.biz_inf_id like '%'||#{dto.busInfoId}||'%' 
	            	and bt.validate_state='1' 
	            	and bt.pro_instance_id in(
					select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
					from jbpm4_hist_procinst hp where hp.id_=t.execution_
					)
	            )
	        </if>
	        <if test="dto.bizTaskType != null and dto.bizTaskType != '' " >    
	            and exists (select * from jbpm4_biz_tab bt where bt.biz_task_type =#{dto.bizTaskType}
	            	and bt.validate_state='1' 
	            	and bt.pro_instance_id in(
					select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
					from jbpm4_hist_procinst hp where hp.id_=t.execution_
					)
	            )
	        </if>
	        <if test="dto.remark != null and dto.remark != '' " >    
	            and exists (select * from jbpm4_biz_tab bt where bt.remark like '%'||#{dto.remark}||'%'
	            	and bt.validate_state='1' 
	            	and bt.pro_instance_id in(
					select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
					from jbpm4_hist_procinst hp where hp.id_=t.execution_
					)
	            )
	        </if>
	        <!-- 2014-11-8 13:56:31 chj add 查询 任务类型  -->
	        <if test="dto.bizType != null and dto.bizType != ''">
	        	and exists (select * from jbpm4_biz_tab bt where bt.biz_type =#{dto.bizType}
	            	and bt.validate_state='1' 
	            	and bt.pro_instance_id in(
					select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
					from jbpm4_hist_procinst hp where hp.id_=t.execution_)
				)
	        </if>
	        <if test="dto.proStartTime != null and dto.proStartTime != ''">
		        	and exists ( select hp.id_ from jbpm4_hist_procinst hp 
		        				where hp.id_ = t.execution_
								and hp.start_  >= to_date(#{dto.proStartTime},'yyyy-MM-dd')
					)
	        </if>
	        <if test="dto.proEndTime != null and dto.proEndTime != ''">
	        	and exists ( select hp.id_ from jbpm4_hist_procinst hp 
	        				 where hp.id_ = t.execution_
							 and hp.start_  <![CDATA[ <= ]]> to_date(#{dto.proEndTime},'yyyy-MM-dd') +1
				)
	        </if>
	        <if test="dto.acitityName != null and dto.acitityName != '' and (eqActName == null or eqActName !=1) " >    
		           and exists (select 1
					          from jbpm4_task t2
						      where t2.execution_id_ = t.execution_
						           and t2.activity_name_ like '%'||#{dto.acitityName}||'%'
					           )
	        </if>
	        <if test="dto.acitityName != null and dto.acitityName != '' and eqActName == 1 " >    
	            and exists (select 1
					          from jbpm4_task t2
						      where t2.execution_id_ = t.execution_
						           and t2.activity_name_ =#{dto.acitityName}
					           )
	        </if>
	        /*自定义工作流 数据权限控制*/
	        <if test="dataCSQL != null and dataCSQL != ''">
	        	${dataCSQL}
	        </if>
	        /*角色映射权限控制*/
	        <if test="dto.roleMappingSql != null and dto.roleMappingSql != ''">
	        	${dto.roleMappingSql}
	        </if>
			order by t.end_ desc
</select>

<!-- 查询 个人的已经办结的任务 历史信息-->
<select id="queryPersonalEndTaskInfo_1" parameterType="java.util.HashMap" resultType="java.util.HashMap">
	SELECT TEMP.* FROM (
    select  ROWNUM NUM,
    T.*,
    count(1) over() totalRecordNum
    	from(
	        select 
				 t1.ID
				,t1.ID				BIZ_TAB_ID
				,t1.BIZ_TAB_NAME
				,t1.BIZ_TYPE
				,t1.BIZ_INF_ID
				,t1.BIZ_INF_NAME
				,t1.BIZ_TASK_TYPE
				,t1.PRO_INSTANCE_ID
				,t1.PRO_INSTANCE_ID CUR_EXE_ID
				,t1.START_PRO_USERID
				,t1.PRO_INSTANCE_STATE
				,t1.TASK_STATE
				,t1.OWNER_ID
				,t1.ORG_ID
				,to_char(t1.CREATE_TIME ,'YYYY-MM-DD HH24:MI:SS') CREATE_TIME
				,(select to_char(h1.end_ ,'YYYY-MM-DD HH24:MI:SS') from jbpm4_hist_procinst h1 where h1.id_=t1.pro_instance_id ) PRO_END_TIME
				,t1.REMARK
				,t1.IS_HIDDEN
				
				from jbpm4_biz_tab t1
				where t1.validate_state='1'
				/*考虑一条业务数据多次审核*/
				and t1.id in (select max(t2.id) from jbpm4_biz_tab t2 where t2.validate_state='1' group by t2.biz_tab_name,t2.biz_inf_id,t2.biz_type)
				
				/*判断流程是否 已经办结*/
				and exists (select hp.* from jbpm4_hist_procinst hp where hp.end_ is not null and instr(hp.state_,'active')=0 and hp.id_=t1.pro_instance_id )
               <if test="dto.paramUserId != null" > 
					and (exists (select ht.* from jbpm4_hist_task ht where ht.assignee_ ='${dto.paramUserId}'  and instr(ht.execution_,t1.pro_instance_id) >0)
					    or exists (
					    select ht.* from jbpm4_hist_task ht where ht.assignee_ ='${dto.paramUserId}'  
					           and exists(select hp.id_ from jbpm4_hist_procinst hp where hp.id_ = ht.execution_ and instr(hp.main_id_ ,t1.pro_instance_id) >0) 
					    )
					)
			    </if>
			    <if test="dto.processInsId !=null and dto.processInsId!=''">
			    	and t1.pro_instance_id=#{dto.processInsId}
			    </if>
			    <if test="dto.startTime != null and dto.startTime != ''" >    
		            and  <![CDATA[  t1.create_time >= to_date(#{dto.startTime},'yyyy-MM-dd') ]]>
		        </if>
		        <if test="dto.endTime != null and dto.endTime != ''" >    
		            and  <![CDATA[  t1.create_time <=  to_date(#{dto.endTime},'yyyy-MM-dd')+1 ]]>
		        </if>
				<if test="dto.busInfoName != null and dto.busInfoName != '' " >    
		            and t1.biz_inf_name like '%'||#{dto.busInfoName}||'%' 
		        </if>
		        <if test="dto.busInfoId != null and dto.busInfoId != '' " >    
		            and t1.biz_inf_id like '%'||#{dto.busInfoId}||'%' 
		        </if>
		        <if test="dto.bizTaskType != null and dto.bizTaskType != '' " >    
		            and t1.biz_task_type =#{dto.bizTaskType}
		        </if>
		        <if test="dto.remark != null and dto.remark != '' " >    
		            and t1.remark like '%'||#{dto.remark}||'%'
		        </if>
		        <!-- 2014-11-8 14:19:15 chj 新增 任务类型 -->
		        <if test="dto.bizType != null and dto.bizType != ''">
		        	and t1.biz_type = #{dto.bizType}
		        </if>
			     /*自定义工作流 数据权限控制*/
		        <if test="dataCSQL != null and dataCSQL != ''">
		        	${dataCSQL}
		        </if>
		        
			order by t1.id desc 
		) T 
		) TEMP
		
			<if test="page != null" >    
	            <![CDATA[
	            WHERE TEMP.NUM >  #{page.startIndex} AND TEMP.NUM <= #{page.startIndex} + #{page.pageSize}
	            ]]>
	        </if>
</select>

<!-- 查询 个人的已结的任务 流程实例是结束的 不支持 主子流程 会签流程-->
<select id="queryPersonalEndTaskInfo" parameterType="java.util.HashMap" resultType="java.util.HashMap">
	SELECT TEMP.* FROM (
    select  ROWNUM NUM,
    T.*,
    count(1) over() totalRecordNum
    	from(
	        select 
				 t1.ID
				,t1.ID				BIZ_TAB_ID
				,t1.BIZ_TAB_NAME
				,t1.BIZ_TYPE
				,t1.BIZ_INF_ID
				,t1.BIZ_INF_NAME
				,t1.BIZ_TASK_TYPE
				,t1.PRO_INSTANCE_ID
				,t1.PRO_INSTANCE_ID CUR_EXE_ID
				,t1.START_PRO_USERID
				,t1.PRO_INSTANCE_STATE
				,t1.TASK_STATE
				,t1.OWNER_ID
				,t1.ORG_ID
				,to_char(t1.CREATE_TIME ,'YYYY-MM-DD HH24:MI:SS') CREATE_TIME
				,(select to_char(h1.end_ ,'YYYY-MM-DD HH24:MI:SS') from jbpm4_hist_procinst h1 where h1.id_=t1.pro_instance_id ) PRO_END_TIME
				,t1.REMARK
				,t1.IS_HIDDEN
				
				from jbpm4_biz_tab t1
				where t1.validate_state='1'
				/*考虑一条业务数据多次审核*/
				and t1.id in (select max(t2.id) from jbpm4_biz_tab t2 where t2.validate_state='1' group by t2.biz_tab_name,t2.biz_inf_id,t2.biz_type)
				
				/*判断流程是否 已经办结*/
				and exists (select hp.* from jbpm4_hist_procinst hp where hp.end_ is not null  and hp.id_=t1.pro_instance_id )
               <if test="dto.paramUserId != null" > 
				and exists (select ht.execution_ from jbpm4_hist_task ht where ht.assignee_ ='${dto.paramUserId}'  and  ht.execution_  = t1.pro_instance_id )
			    </if>
			    <if test="dto.processParticipationName != null and dto.processParticipationName != ''" >    
	            and exists (select ht.execution_ from jbpm4_hist_task ht where ht.assignee_ in (${dto.processParticipationName})  and  ht.execution_  = t1.pro_instance_id )
	        	</if>
			    <if test="dto.processInsId !=null and dto.processInsId!=''">
			    	and t1.pro_instance_id=#{dto.processInsId}
			    </if>
			    <if test="dto.startTime != null and dto.startTime != ''" >    
		            and  <![CDATA[  t1.create_time >= to_date(#{dto.startTime},'yyyy-MM-dd') ]]>
		        </if>
		        <if test="dto.endTime != null and dto.endTime != ''" >    
		            and  <![CDATA[  t1.create_time <=  to_date(#{dto.endTime},'yyyy-MM-dd')+1 ]]>
		        </if>
				<if test="dto.busInfoName != null and dto.busInfoName != '' " >    
		            and t1.biz_inf_name like '%'||#{dto.busInfoName}||'%' 
		        </if>
		        <if test="dto.busInfoId != null and dto.busInfoId != '' " >    
		            and t1.biz_inf_id like '%'||#{dto.busInfoId}||'%' 
		        </if>
		        <if test="dto.bizTaskType != null and dto.bizTaskType != '' " >    
		            and t1.biz_task_type =#{dto.bizTaskType}
		        </if>
		        <if test="dto.remark != null and dto.remark != '' " >    
		            and t1.remark like '%'||#{dto.remark}||'%'
		        </if>
		        <!-- 2014-11-8 14:19:15 chj 新增 任务类型 -->
		        <if test="dto.bizType != null and dto.bizType != ''">
		        	and t1.biz_type = #{dto.bizType}
		        </if>
		        /*自定义业务表与工作流表关联的sql条件控制*/
		        <if test="myExtSQL != null and myExtSQL != ''">
		        	${myExtSQL}
		        </if>
			     /*自定义工作流 数据权限控制*/
		        <if test="dataCSQL != null and dataCSQL != ''">
		        	${dataCSQL}
		        </if>
		        /*角色映射权限控制*/
		        <if test="dto.roleMappingSql != null and dto.roleMappingSql != ''">
		        	${dto.roleMappingSql}
		        </if>
		        
			order by t1.id desc 
		) T 
		) TEMP
		
			<if test="page != null" >    
	            <![CDATA[
	            WHERE TEMP.NUM >  #{page.startIndex} AND TEMP.NUM <= #{page.startIndex} + #{page.pageSize}
	            ]]>
	        </if>
</select>
<!-- 通过平台公共分页查询 个人的已结的任务 流程实例是结束的 不支持 主子流程 会签流程-->
<select id="queryPersonalEndTaskInfoByPaging" parameterType="java.util.HashMap" resultType="java.util.HashMap">
	        select 
				 t1.ID
				,t1.ID				BIZ_TAB_ID
				,t1.BIZ_TAB_NAME
				,t1.BIZ_TYPE
				,t1.BIZ_INF_ID
				,t1.BIZ_INF_NAME
				,t1.BIZ_TASK_TYPE
				,t1.PRO_INSTANCE_ID
				,t1.PRO_INSTANCE_ID CUR_EXE_ID
				,t1.START_PRO_USERID
				,t1.PRO_INSTANCE_STATE
				,t1.TASK_STATE
				,t1.OWNER_ID
				,t1.ORG_ID
				,to_char(t1.CREATE_TIME ,'YYYY-MM-DD HH24:MI:SS') CREATE_TIME
				,(select to_char(h1.end_ ,'YYYY-MM-DD HH24:MI:SS') from jbpm4_hist_procinst h1 where h1.id_=t1.pro_instance_id ) PRO_END_TIME
				,t1.REMARK
				,t1.IS_HIDDEN
				
				from jbpm4_biz_tab t1
				where t1.validate_state='1'
				/*考虑一条业务数据多次审核*/
				and t1.id in (select max(t2.id) from jbpm4_biz_tab t2 where t2.validate_state='1'
				/*判断流程是否 已经办结*/
				and exists (select hp.* from jbpm4_hist_procinst hp where hp.end_ is not null  and hp.id_=t2.pro_instance_id )
               <if test="dto.paramUserId != null" > 
				and exists (select ht.execution_ from jbpm4_hist_task ht where ht.assignee_ ='${dto.paramUserId}'  and  ht.execution_  = t2.pro_instance_id )
			    </if>
			    <if test="dto.processParticipationName != null and dto.processParticipationName != ''" >    
	            and exists (select ht.execution_ from jbpm4_hist_task ht where ht.assignee_ in (${dto.processParticipationName})  and  ht.execution_  = t2.pro_instance_id )
	        	</if>
			    <if test="dto.processInsId !=null and dto.processInsId!=''">
			    	and t2.pro_instance_id=#{dto.processInsId}
			    </if>
			    <if test="dto.startTime != null and dto.startTime != ''" >    
		            and  <![CDATA[  t2.create_time >= to_date(#{dto.startTime},'yyyy-MM-dd') ]]>
		        </if>
		        <if test="dto.endTime != null and dto.endTime != ''" >    
		            and  <![CDATA[  t2.create_time <=  to_date(#{dto.endTime},'yyyy-MM-dd')+1 ]]>
		        </if>
				<if test="dto.busInfoName != null and dto.busInfoName != '' " >    
		            and t2.biz_inf_name like '%'||#{dto.busInfoName}||'%' 
		        </if>
		        <if test="dto.busInfoId != null and dto.busInfoId != '' " >    
		            and t2.biz_inf_id like '%'||#{dto.busInfoId}||'%' 
		        </if>
		        <if test="dto.bizTaskType != null and dto.bizTaskType != '' " >    
		            and t2.biz_task_type =#{dto.bizTaskType}
		        </if>
		        <if test="dto.remark != null and dto.remark != '' " >    
		            and t2.remark like '%'||#{dto.remark}||'%'
		        </if>
		        <!-- 2014-11-8 14:19:15 chj 新增 任务类型 -->
		        <if test="dto.bizType != null and dto.bizType != ''">
		        	and t2.biz_type = #{dto.bizType}
		        </if>
		        
				group by t2.biz_tab_name,t2.biz_inf_id,t2.biz_type)
				
		        /*自定义业务表与工作流表关联的sql条件控制*/
		        <if test="myExtSQL != null and myExtSQL != ''">
		        	${myExtSQL}
		        </if>
			     /*自定义工作流 数据权限控制*/
		        <if test="dataCSQL != null and dataCSQL != ''">
		        	${dataCSQL}
		        </if>
		        /*角色映射权限控制*/
		        <if test="dto.roleMappingSql != null and dto.roleMappingSql != ''">
		        	${dto.roleMappingSql}
		        </if>
		        
			order by t1.id desc 
</select>	
<!-- 查询 结束的流程实例信息 QUERY_END_PRO_INFO_BY_MY_SQL-->
<select id="queryEndProInfoByMySql" parameterType="java.util.HashMap" resultType="java.util.HashMap">
	SELECT TEMP.* FROM (
    select  ROWNUM NUM,
    T.*,
    count(1) over() totalRecordNum
    	from(
    	
      select
      	   t1.dbid_					, 
     	   t1.procdefid_			,
	       t1.id_					,
	       t1.state_				,
	       t1.dbversion_			,
	       to_char(t1.start_,'YYYY-MM-DD HH24:MI:SS')    start_,
	       to_char(t1.end_,'YYYY-MM-DD HH24:MI:SS')      end_,
	       t1.endactivity_
	       
       	from jbpm4_hist_procinst t1
<![CDATA[where t1.end_ is not null ]]>
		<if test="dto.processInsId != null" >  
		        	and t1.id_ like '%'||#{dto.processInsId}||'%'
		</if>
		
		<if test="dto.acitityName != null" >  
		        	and t1.endactivity_=#{dto.acitityName#
		</if>
       
		order by t1.end_ desc
		) T
		) TEMP
		<if test="page != null" >    
            <![CDATA[
            WHERE TEMP.NUM >  #{page.startIndex} AND TEMP.NUM <= #{page.startIndex} + #{page.pageSize}
            ]]>
        </if>
	</select>
	<!-- 查询参与者的相关信息 -->
  <select id="queryCurrentPlayer" parameterType="java.util.HashMap" resultType="java.lang.String">
  		 select j.assignee_ from jbpm4_task j where j.execution_id_ = #{mainId} 
  		 and j.activity_name_ = #{name}
  </select>
	
	
	<!-- 查询会签子流归属的主流程实例id -->
  <select id="queryMainProInsIdByHuiQainSubPro" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		select e1.id_            pro_ins_id 
     
     from jbpm4_execution e1 where 1 = 1  
     and ( exists    (
 
      select e.parent_ 

      from jbpm4_execution e 
      where 1 =1 
      and e1.dbid_ = e.parent_ 

      and exists (select d.main_id_ from jbpm4_hist_procinst d where d.id_=#{proInsId} and d.main_id_  = e.id_ )

      )
      or exists (select d.main_id_ from jbpm4_hist_procinst d
                 	where d.id_ = #{proInsId}
                    and d.main_id_ = e1.id_)  
      )
		 
	</select>
	
	
	<!-- 通过主流程实例id查询出该主流程实例名下 最新的待办任务信息 -->
	<select id="queryLastTaskInfoByMainProInsId" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		select to_char(t.dbid_)					dbid,
		       to_char(t.execution_id_)			execution_id,
		       to_char(t.assignee_)				assignee
		 
		 	from jbpm4_task t where 1 =1 
		
		and exists (select p.id_ from jbpm4_hist_procinst p 
		where p.end_ is null  
		and p.state_='active' 
		and ( p.main_id_=#{mainProInsId# or p.id_=#{mainProInsId})
		and p.id_ = t.execution_id_ 
		)
		order by t.create_ desc 
		 
	</select>
	
	<select id="queryJbpm4LobInfoByProkey" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		select to_char(t1.dbid_)           dbid, 
		       to_char(t1.name_)  			name, 
		       to_char(t1.deployment_)      deployment

	  		from jbpm4_lob t1
	
			where 1=1  
			and t1.deployment_ = (select max(d.deployment_) from jbpm4_deployprop d where d.stringval_=#{proKey})
		 
	</select>
	
	<!-- 查询该流程的在部署时的 流程定义id -->
  <select id="queryMaxDeploymnetId" parameterType="java.util.HashMap" resultType="java.lang.String" >
    	 select max(d.deployment_) deploymentId from jbpm4_deployprop d 
    	 
    	 where d.objname_ = #{processName} 
    	 and d.longval_=#{proVersion}
				
  </select>
  
  <!-- 更新流程定义信息 -->
<update id="updateJbpm4Lob" parameterType="com.jy.platform.jbpm4.dto.JbpmBlobDTO">
		update jbpm4_lob l set l.blob_value_=#{contents} 
		
		where l.deployment_=#{id}
</update>

	
	<insert id="addJbpm4FormInfo" parameterType="java.util.HashMap">
	<selectKey resultType="java.lang.Long" keyProperty="id" order="BEFORE" >
				select seq_jbpm4_form_info.nextval from dual
	</selectKey>
		<![CDATA[
		insert into jbpm4_form_info
		(   		
				id                             ,
				pro_def_key                    ,
				pro_activity_name              ,
				pro_activity_form              ,
				participator_type              ,
				PART_TYPE                    ,
				other_params                   ,
				rule_info                      ,
				create_time                    ,
				remark                         ,
				ext1                           ,
				ext2                           ,
				ext3                           ,
				validate_state                 ,
				pro_level                      
		)
		values(#{id}
					,#{dto.proDefKey,jdbcType=VARCHAR}
					,#{dto.proActivityName,jdbcType=VARCHAR}
					,#{dto.proActivityForm,jdbcType=VARCHAR}
					,#{dto.participatorType,jdbcType=VARCHAR}
					,#{dto.partType,jdbcType=VARCHAR}
					,#{dto.otherParams,jdbcType=VARCHAR}
					,#{dto.ruleInfo,jdbcType=VARCHAR}
					,sysdate
					,#{dto.remark,jdbcType=VARCHAR}
					,#{dto.ext1,jdbcType=VARCHAR}
					,#{dto.ext2,jdbcType=VARCHAR}
					,#{dto.ext3,jdbcType=VARCHAR}
					,'1'
					,#{dto.proLevel,jdbcType=VARCHAR}
		)
		]]>
	</insert>
	
	
	  <update id="deleteJbpm4FormInfo" parameterType="java.util.HashMap">
    <![CDATA[  
       update jbpm4_form_info t1
       set 
       t1.validate_state='0'
       where t1.id in ($ids$)
    ]]>
  </update>
  
  <select id="queryListOfJbpm4FormInfoPage" parameterType="java.util.HashMap" resultType="java.util.HashMap" >
   SELECT TEMP.* FROM (
         select  ROWNUM NUM,
                 T.*,
                 count(1) over() totalRecordNum
    	 from(
    	 		select 
						t1.id                             ,
						t1.pro_def_key                    ,
						t1.pro_activity_name              ,
						t1.pro_activity_form              ,
						t1.participator_type              ,
						t1.PART_TYPE                    ,
						t1.other_params                   ,
						t1.rule_info                      ,
						t1.create_time                    ,
						t1.remark                         ,
						t1.ext1                           ,
						t1.ext2                           ,
						t1.ext3                           ,
						t1.validate_state                 ,
						t1.pro_level                      
					
				from jbpm4_form_info 		t1
				where t1.validate_state='1'
					
					<if test="dto.id != null" >
					  <![CDATA[and t1.ID =#{dto.id}]]>
					</if>
					
					<if test="dto.proDefKey != null" >
					 <![CDATA[and t1.PRO_DEF_KEY =#{dto.proDefKey}]]>
					</if>
					
					<if test="dto.proActivityName != null" >
					 <![CDATA[and t1.PRO_ACTIVITY_NAME =#{dto.proActivityName}]]>
					</if>
					<if test="dto.proActivityForm != null" >
						  <![CDATA[and t1.PRO_ACTIVITY_FORM =#{dto.proActivityForm}]]>
					</if>
					
					<if test="dto.participatorType != null" >
					<![CDATA[and t1.PARTICIPATOR_TYPE =#{dto.participatorType}]]>
					</if>
					
					<if test="dto.partType != null" >
					<![CDATA[and t1.PART_TYPE =#{dto.partType}]]>
					</if>
					
					<if test="dto.otherParams != null" >
						  <![CDATA[and t1.OTHER_PARAMS =#{dto.otherParams}]]>
					</if>
					<if test="dto.ruleInfo != null" >
						  <![CDATA[and t1.RULE_INFO =#{dto.ruleInfo}]]>
					</if>
					
					<if test="dto.createTime != null" >
						  <![CDATA[and t1.CREATE_TIME =#{dto.createTime}]]>
					</if>
					
					<if test="dto.remark != null" >
						  <![CDATA[and t1.REMARK =#{dto.remark}]]>
					</if>
					<if test="dto.ext1 != null" >
						  <![CDATA[and t1.EXT1 =#{dto.ext1}]]>
					</if>
					<if test="dto.ext2 != null" >
						  <![CDATA[and t1.EXT2 =#{dto.ext2}]]>
					</if>
					<if test="dto.ext3 != null" >
						  <![CDATA[and t1.EXT3 =#{dto.ext3}]]>
					</if>
					<if test="dto.validateState != null" >
						  <![CDATA[and t1.VALIDATE_STATE =#{dto.validateState}]]>
					</if>
					<if test="dto.proLevel != null" >
						  <![CDATA[and t1.PRO_LEVEL =#{dto.proLevel}]]>
					</if>
				
				order by t1.id desc
		     ) T
		) TEMP
		
		<if test="pager != null" >    
	            <![CDATA[WHERE TEMP.NUM > #{pager.offset} and TEMP.NUM <= (#{pager.pageSize}+#{pager.offset})]]>
	    </if>
  </select>
  
  
  <select id="queryOneJbpm4FormInfo" parameterType="java.util.HashMap" resultMap="Jbpm4FormInfoDTO" >
    	 		select 
						t1.id                             ,
						t1.pro_def_key                    ,
						t1.pro_activity_name              ,
						t1.pro_activity_form              ,
						t1.participator_type              ,
						t1.PART_TYPE                    ,
						t1.other_params                   ,
						t1.rule_info                      ,
						t1.create_time                    ,
						t1.remark                         ,
						t1.ext1                           ,
						t1.ext2                           ,
						t1.ext3                           ,
						t1.validate_state                 ,
						t1.pro_level                      
				from jbpm4_form_info 		t1
				where t1.validate_state='1'
				<if test="dto.id != null" >  
						  <![CDATA[and t1.id =#{dto.id}]]>
				</if>
				<if test="proDefKey != null" >  
						  and t1.PRO_DEF_KEY =#{proDefKey}
				</if>
				<if test="proActivityName != null" >  
						  and t1.PRO_ACTIVITY_NAME =#{proActivityName}
				</if>
				<if test="proLevel != null" >  
						  and t1.PRO_LEVEL =#{proLevel}
				</if>
				
  </select>
  
  <update id="updateJbpm4FormInfo" parameterType="java.util.HashMap">
    <![CDATA[  
       update jbpm4_form_info t1
       set 
		t1.PRO_DEF_KEY=#{dto.proDefKey,jdbcType=VARCHAR}, 
		t1.PRO_ACTIVITY_NAME=#{dto.proActivityName,jdbcType=VARCHAR}, 
		t1.PRO_ACTIVITY_FORM=#{dto.proActivityForm,jdbcType=VARCHAR}, 
		t1.PARTICIPATOR_TYPE=#{dto.participatorType,jdbcType=VARCHAR}, 
		t1.PART_TYPE=#{dto.partType,jdbcType=VARCHAR}, 
		t1.OTHER_PARAMS=#{dto.otherParams,jdbcType=VARCHAR}, 
		t1.RULE_INFO=#{dto.ruleInfo,jdbcType=VARCHAR}, 
		t1.CREATE_TIME=sysdate, 
		t1.REMARK=#{dto.remark,jdbcType=VARCHAR}, 
		t1.EXT1=#{dto.ext1,jdbcType=VARCHAR}, 
		t1.EXT2=#{dto.ext2,jdbcType=VARCHAR}, 
		t1.EXT3=#{dto.ext3,jdbcType=VARCHAR}, 
		t1.PRO_LEVEL=#{dto.proLevel,jdbcType=VARCHAR}
				
       where t1.id=#{dto.id}
    ]]>
  </update>
  
  
   <select id="queryFormInfoIdBySql" parameterType="java.util.HashMap" resultType="java.lang.String" >
    	 		select 
						to_char(t1.id) 				id
						                             
						from jbpm4_form_info 		t1
						where t1.validate_state='1'
						
						  <![CDATA[and t1.PRO_DEF_KEY =#{proDefKey}]]>
						  <![CDATA[and t1.PRO_ACTIVITY_NAME =#{proActivityName}]]>
						  <![CDATA[and t1.pro_level =#{proLevel}]]>
				
  </select>
  
  <update id="deleteOldProcessInfoBySql" parameterType="java.util.HashMap">
       update temporary_jbpm4_info t1
       set 
		t1.VALIDATE_STATE='0'
		,t1.LAST_UPD_BY=#{dto.lastUpdBy,jdbcType=VARCHAR}
		,t1.LAST_UPD=sysdate
				
       where 1 =1 
       <!-- -->
       and t1.proc_name=#{dto.procName,jdbcType=VARCHAR} 
       and t1.proc_code=#{dto.procCode,jdbcType=VARCHAR}
       and t1.proc_version=#{dto.procVersion,jdbcType=VARCHAR}
       and t1.validate_state='1'
  </update>
  
  <insert id="addTemporaryJbpm4Info" parameterType="java.util.HashMap">
	<selectKey resultType="java.lang.Long" keyProperty="id" order="BEFORE" >
				select seq_temporary_jbpm4_info.nextval as id from dual
	</selectKey>
		<![CDATA[
		insert into temporary_jbpm4_info
		(   		
				id                             ,
				xml_content                    ,
				validate_state                 ,
				created_by                     ,
				created                        ,
				remark                         ,
				ext1                           ,
				proc_version				  ,
				proc_code					  ,
				proc_name					  ,
				biz_file
		)
		values(#{id}
					,#{dto.xmlContent}
					,'1'
					,#{dto.lastUpdBy,jdbcType=VARCHAR}
					,sysdate
					,#{dto.remark,jdbcType=VARCHAR}
					,#{dto.ext1,jdbcType=VARCHAR}
					,#{dto.procVersion,jdbcType=VARCHAR}
					,#{dto.procCode,jdbcType=VARCHAR}
					,#{dto.procName,jdbcType=VARCHAR}
					,#{dto.bizFile,jdbcType=VARCHAR}
		)
		]]>
	</insert>
	
	<update id="deleteTemporaryJbpm4Info" parameterType="java.util.HashMap">
    <![CDATA[  
       update temporary_jbpm4_info t1
       set 
       t1.validate_state='0'
       where t1.id in (${ids})
    ]]>
  </update>
<!-- 分页查询 流程设计临时表 列表信息 -->	
	<select id="queryListOfTemporaryJbpm4InfoPage" parameterType="java.util.HashMap" resultMap="TemporaryJbpm4InfoDTO" >
   SELECT TEMP.* FROM (
         select  ROWNUM NUM,
                 T.*,
                 count(1) over() totalRecordNum
    	 from(
    	 		select 
						t1.id                             ,
						t1.xml_content                    ,
						t1.validate_state                 ,
						t1.last_upd_by                    ,
						to_char(t1.last_upd,'YYYY-MM-DD HH24:MI:SS') last_upd,
						t1.created_by                     ,
						to_char(t1.created,'YYYY-MM-DD HH24:MI:SS')   created,
						t1.remark                         ,
						t1.ext1                           ,
						t1.proc_version					  ,
						t1.proc_code					  ,
						t1.proc_name					  ,
						t1.biz_file
					
				from temporary_jbpm4_info 		t1
				where t1.validate_state='1'
					<if test="dto.id != null and dto.id != '' " >   
						  <![CDATA[and t1.ID =#{dto.id}]]>
					</if>
					<if test="dto.validateState != null and dto.validateState != '' " >   
						  <![CDATA[and t1.VALIDATE_STATE =#{dto.validateState}]]>
					</if>
					<if test="dto.remark != null and dto.remark != '' " >
						 <![CDATA[and t1.REMARK like '%'||#{dto.remark}||'%']]>
					</if>
					<if test="dto.procVersion != null and dto.procVersion != '' " >
						  <![CDATA[and t1.proc_version like '%'||#{dto.procVersion}||'%']]>
					</if>
					<if test="dto.procCode != null and dto.procCode != '' " >
						<![CDATA[and t1.proc_code like '%'||#{dto.procCode}||'%']]>
					</if>
					<if test="dto.procName != null and dto.procName != '' " >
						<![CDATA[and t1.proc_name like '%'||#{dto.procName}||'%']]>
					</if>
					<if test="dto.bizFile != null and dto.bizFile != '' " >
						<![CDATA[and t1.biz_file like '%'||#{dto.bizFile}||'%']]>
					</if>
				order by t1.id desc
		     ) T
		) TEMP
		
		<if test="page != null" >    
	            <![CDATA[WHERE TEMP.NUM > #{page.startIndex} and TEMP.NUM <= (#{page.startIndex} + #{page.pageSize})]]>
        </if>
  </select>
  
   <!-- 查询个人创建的流程信息 -->
  <select id="querySomeTemporaryJbpm4InfoBySql" parameterType="java.util.HashMap" resultMap="TemporaryJbpm4InfoDTO" >
    	 		select 
						t1.id                             ,
						t1.xml_content                    ,
						t1.validate_state                 ,
						t1.last_upd_by                    ,
						to_char(t1.last_upd,'YYYY-MM-DD HH24:MI:SS') last_upd,
						t1.created_by                     ,
						to_char(t1.created,'YYYY-MM-DD HH24:MI:SS')   created,
						t1.remark                         ,
						t1.ext1                           ,
						t1.proc_version					  ,
						t1.proc_code					  ,
						t1.proc_name					  ,
						t1.biz_file
				from temporary_jbpm4_info 		t1
				where t1.validate_state='1'
				
  </select>
  
  <select id="queryOneTemporaryJbpm4_info" parameterType="java.util.HashMap" resultMap="TemporaryJbpm4InfoDTO" >
    	 		select 
						 t1.id             
						,t1.xml_content    
						,t1.validate_state 
						,t1.last_upd_by    
						,to_char(t1.last_upd,'YYYY-MM-DD HH24:MI:SS') last_upd
						,t1.created_by     
						,to_char(t1.created,'YYYY-MM-DD HH24:MI:SS')   created 
						,t1.remark         
						,t1.ext1           
						,t1.proc_version		
						,t1.proc_code				
						,t1.proc_name				
						,t1.biz_file				
						,'1'	num
						,'1'	totalRecordNum
				from temporary_jbpm4_info 		t1
				where 1 = 1 
				<if test="id != null" >    
						  <![CDATA[and t1.id =#{id}]]>
				</if>
  </select>
  
  <update id="updateTemporaryJbpm4Info" parameterType="java.util.HashMap">
    <![CDATA[  
       update temporary_jbpm4_info t1
       set 
		t1.XML_CONTENT=#{dto.xmlContent}, 
		t1.VALIDATE_STATE=#{dto.validateState}, 
		t1.LAST_UPD_BY=#{dto.lastUpdBy}, 
		t1.LAST_UPD=sysdate, 
		t1.REMARK=#{dto.remark}, 
		t1.EXT1=#{dto.ext1},
		t1.proc_version=#{dto.procVersion},
		t1.proc_code=#{dto.procCode},
		t1.proc_name=#{dto.procName},
		t1.biz_file=#{dto.bizFile}
				
       where t1.id=#{dto.id}
    ]]>
  </update>
  
    <select id="queryTempWorkflowIBySql" parameterType="java.util.HashMap" resultType="java.lang.String" >
    	select max(t.id) 		id 
    	from temporary_jbpm4_info t 
    	where 1 =1 
    	and t.proc_name =#{processName} 
    	and t.proc_version =#{processVersion]
  </select>
  
  <!-- 发布流程成功后更新流程图片 -->
   <update id="updateProPngOfTempJbpm4Info" parameterType="com.jy.platform.jbpm4.dto.JbpmBlobDTO">
       begin 
       
	       update temporary_jbpm4_info t1
	       set 
	       t1.pro_png=''
	       where 
	       t1.proc_name= ( select t2.proc_name from temporary_jbpm4_info t2 where t2.id=#{id})
	       and t1.proc_version=( select t2.proc_version from temporary_jbpm4_info t2 where t2.id=#{id})
	       and t1.pro_png is not null ;
	       
	       update temporary_jbpm4_info t1
	       set 
	       t1.pro_png=#{contents}
	       where t1.id =#{id};
       
       end;
  </update>
  
  <!--设置blob字段的返回格式-->  
<resultMap id="proPng" type="com.jy.platform.jbpm4.dto.JbpmBlobDTO">
		<result property="contents" column="PRO_PNG" jdbcType="BLOB" />
</resultMap>
  
<select id="queryProPngByProNameAndVersion" parameterType="java.util.HashMap" resultMap="proPng" >
  	 		select 
				t1.pro_png
		from temporary_jbpm4_info 		t1
		where 1 =1 
 				
 				<if test="id != null and id != '' " >    
				 and t1.id=#{id}
		</if>
		<if test="processName != null and processName != ''" >    
				and t1.proc_name=#{processName}
		</if>
		<if test="processVersion != null and processVersion != ''" >    
				and t1.proc_version=#{processVersion}
		</if>
		<if test="processInstantceId != null and processInstantceId != '' " >    
				and t1.proc_name=(select d.objname_ from jbpm4_deployprop d where 
 										d.stringval_=(select p.procdefid_ from jbpm4_hist_procinst p where instr(#{processInstantceId},p.id_)>0 ))	
			and t1.proc_version =
			(select d1.longval_ from jbpm4_deployprop d1 where d1.key_='pdversion' 
			and d1.objname_ = (select d.objname_ from jbpm4_deployprop d 
										where d.stringval_=(select p.procdefid_ from jbpm4_hist_procinst p where instr(#{processInstantceId},p.id_)>0)
							  )
			)
		</if>
		<!-- 通过流程定义key 查找流程图 则取最新的流程图 -->
		<if test="processDefKey != null and processDefKey != '' " >    
				and t1.proc_name=( 
 										select tt.objname_ from (
									select d.objname_ ,max(d.deployment_) max_deployment_id 
										from jbpm4_deployprop d 
										where d.stringval_=#{processDefKey} 
										group by d.objname_ 
									) tt
 										)	
			and t1.proc_version =
			(select d1.longval_ from jbpm4_deployprop d1 where d1.key_='pdversion' 
			and d1.deployment_ = (select tt.max_deployment_id from (
									select d.objname_ ,max(d.deployment_) max_deployment_id 
										from jbpm4_deployprop d 
										where d.stringval_=#{processDefKey} 
										group by d.objname_ 
									) tt
							  )
			)
		</if>
		
		
		and t1.pro_png is not null 
</select>
  <!-- 查询 活动着的流程实例信息 QUERY_ACTIVE_PRO_INFO_BY_MY_SQL-->
	<select id="queryActiveProInfoByMySql" parameterType="java.util.HashMap" resultType="java.util.HashMap">
	SELECT TEMP.* FROM (
    select  ROWNUM NUM,
    T.*,
    count(1) over() totalRecordNum
    	from(
    	
       select 
       		t1.activityname_  			CUR_ACT_NAME
	        ,t1.id_						CUR_EXE_ID
	        ,t1.procdefid_ 		
	        ,(select t.assignee_ from jbpm4_task t where 
	        t.execution_id_=(select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
				from jbpm4_hist_procinst hp where hp.dbid_=t1.instance_)
			)  									EXE_USER_ID		
	        ,(select to_char(p.start_,'YYYY-MM-DD HH24:MI:SS')  from jbpm4_hist_procinst p where p.dbid_=t1.instance_)  	START_TIME
	        ,(select b.biz_inf_name from jbpm4_biz_tab b where 
	        b.pro_instance_id = (select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
				from jbpm4_hist_procinst hp where hp.dbid_=t1.instance_)
			) 							BIZ_INF_NAME
        	,(select b.biz_type from jbpm4_biz_tab b where 
        	b.pro_instance_id = (select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
				from jbpm4_hist_procinst hp where hp.dbid_=t1.instance_)
			) 								BIZ_TYPE
        	,(select b.biz_inf_no from jbpm4_biz_tab b where 
        	b.pro_instance_id = (select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
				from jbpm4_hist_procinst hp where hp.dbid_=t1.instance_)
			)							BIZ_INF_NO
        	,(select b.id from jbpm4_biz_tab b where 
        	b.pro_instance_id = (select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
				from jbpm4_hist_procinst hp where hp.dbid_=t1.instance_)
			)  									BIZ_TAB_ID
        	,(select b.biz_tab_name from jbpm4_biz_tab b where 
        	b.pro_instance_id = (select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
				from jbpm4_hist_procinst hp where hp.dbid_=t1.instance_)
			)  						BIZ_TAB_NAME
       		,(select b.biz_inf_id from jbpm4_biz_tab b where 
       		b.pro_instance_id = (select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
				from jbpm4_hist_procinst hp where hp.dbid_=t1.instance_)
			)  							BIZ_INF_ID
        	,(select b.start_pro_userid from jbpm4_biz_tab b where 
        	b.pro_instance_id = (select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
				from jbpm4_hist_procinst hp where hp.dbid_=t1.instance_)
			)  					start_pro_userid
        	,(select b.pro_instance_state from jbpm4_biz_tab b where 
	        b.pro_instance_id = (select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
				from jbpm4_hist_procinst hp where hp.dbid_=t1.instance_)
			) 							PRO_INSTANCE_STATE
       		from  jbpm4_execution t1
			where 1=1
		<if test="dto.processInsId != null and dto.processInsId != ''" >    
			and t1.id_ like '%'||#{dto.processInsId}||'%'
		</if>
		
		<if test="dto.acitityName != null and dto.acitityName != ''" >    
			and t1.ACTIVITYNAME_=#{dto.acitityName}
		</if>
		<if test="dto.startTime != null and dto.startTime != ''" >    
		    and  exists ( select hp.id_ 
				 from jbpm4_hist_procinst hp where hp.dbid_=t1.instance_
				 and hp.start_ >= to_date(#{dto.startTime},'yyyy-MM-dd')
			)
        </if>
        <if test="dto.endTime != null and dto.endTime != ''" >    
            and  exists ( select hp.id_ 
				 from jbpm4_hist_procinst hp where hp.dbid_=t1.instance_
				 and hp.start_ <![CDATA[<=]]> to_date(#{dto.endTime},'yyyy-MM-dd')+1
			)
        </if>
        
		<if test="dto.bizInfName != null and dto.bizInfName != ''">
        	and exists (select b.biz_inf_name from jbpm4_biz_tab b 
        		where  b.pro_instance_id =(select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
					   from jbpm4_hist_procinst hp where hp.dbid_=t1.instance_)
				and b.biz_inf_name like '%'||#{dto.bizInfName}||'%'
			)
        </if>
        <if test="dto.bizType != null and dto.bizType != ''">
        	and exists (select * from jbpm4_biz_tab bt where bt.biz_type =#{dto.bizType}
            	and bt.pro_instance_id in(
						select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
					   	from jbpm4_hist_procinst hp where hp.dbid_=t1.instance_
				)
			)
        </if>
		
			order by t1.id_ 	desc 
		) T
		) TEMP
		<if test="page != null" >    
            <![CDATA[
            WHERE TEMP.NUM >  #{page.startIndex} AND TEMP.NUM <= #{page.startIndex} + #{page.pageSize}
            ]]>
        </if>
	</select>
	
  <!-- 查询 结束的流程实例信息 QUERY_END_PRO_INFO_BY_MY_SQL-->
	<select id="queryEndPrInfoByMySql" parameterType="java.util.HashMap" resultType="java.util.HashMap">
	SELECT TEMP.* FROM (
    select  ROWNUM NUM,
    T.*,
    count(1) over() totalRecordNum
    	from(
    	
      select
      	     t1.dbid_					 
			,t1.procdefid_			
			,t1.id_	CUR_EXE_ID				
			,t1.state_				
			,t1.dbversion_			
			,to_char(t1.start_ ,'YYYY-MM-DD HH24:MI:SS')    START_TIME
			,to_char(t1.end_   ,'YYYY-MM-DD HH24:MI:SS')      END_TIME
			,t1.endactivity_
	        ,(select b.biz_inf_name from jbpm4_biz_tab b where 
	        	b.pro_instance_id =(select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
				from jbpm4_hist_procinst hp where hp.id_=t1.id_)
			 ) 		BIZ_INF_NAME
	      	,(select b.biz_inf_no from jbpm4_biz_tab b where 
	      		b.pro_instance_id = (select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
				from jbpm4_hist_procinst hp where hp.id_=t1.id_)
			 )  	BIZ_INF_NO
	      	,(select b.BIZ_TYPE from jbpm4_biz_tab b 
	      		where  b.pro_instance_id = (select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
				from jbpm4_hist_procinst hp where hp.id_=t1.id_)
			 )  	BIZ_TYPE
	      	
       	from jbpm4_hist_procinst t1
		<![CDATA[where t1.state_ <> 'active']]>
		<if test="dto.processInsId != null and dto.processInsId != '' " >
			and t1.id_ like '%${dto.processInsId}%'
		</if>
		
		<if test="dto.acitityName != null and dto.acitityName !='' " >
			and t1.endactivity_=#{dto.acitityName}
		</if>
		<if test="dto.startTime != null and dto.startTime != ''" >    
		            and  <![CDATA[  t1.end_ >= to_date(#{dto.startTime},'yyyy-MM-dd') ]]>
        </if>
         <if test="dto.endTime != null and dto.endTime != ''" >    
            and  <![CDATA[  t1.end_ <=  to_date(#{dto.endTime},'yyyy-MM-dd')+1 ]]>
        </if>
		<if test="dto.bizInfName != null and dto.bizInfName != ''">
        	and exists (select b.biz_inf_name from jbpm4_biz_tab b 
        		where  b.pro_instance_id =(select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
					   from jbpm4_hist_procinst hp where hp.id_=t1.id_)
				and b.biz_inf_name like '%'||#{dto.bizInfName}||'%'
			)
        </if>
        <if test="dto.bizType != null and dto.bizType != ''">
        	and exists (select * from jbpm4_biz_tab bt where bt.biz_type =#{dto.bizType}
            	and bt.pro_instance_id in(
						select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
					   	from jbpm4_hist_procinst hp where hp.id_=t1.id_
				)
			)
        </if>
        
			order by t1.end_ desc
		) T
		) TEMP
		
		<if test="page != null" >    
	            <![CDATA[WHERE TEMP.NUM > #{page.startIndex} and TEMP.NUM <= (#{page.startIndex} + #{page.pageSize})]]>
        </if>
	</select>
	<!-- 通过平台公共分页查询 结束的流程实例信息 -->
	<select id="queryEndPrInfoByMySqlByPaging" parameterType="java.util.HashMap" resultType="java.util.HashMap">
      select
      	     t1.dbid_					 
			,t1.procdefid_			
			,t1.id_	CUR_EXE_ID				
			,t1.state_				
			,t1.dbversion_			
			,to_char(t1.start_ ,'YYYY-MM-DD HH24:MI:SS')    START_TIME
			,to_char(t1.end_   ,'YYYY-MM-DD HH24:MI:SS')      END_TIME
			,t1.endactivity_
	      	
       	from jbpm4_hist_procinst t1
		<![CDATA[where t1.state_ <> 'active']]>
		<if test="dto.processInsId != null and dto.processInsId != '' " >
			and t1.id_ like '%${dto.processInsId}%'
		</if>
		
		<if test="dto.acitityName != null and dto.acitityName !='' " >
			and t1.endactivity_=#{dto.acitityName}
		</if>
		<if test="dto.startTime != null and dto.startTime != ''" >    
		            and  <![CDATA[  t1.end_ >= to_date(#{dto.startTime},'yyyy-MM-dd') ]]>
        </if>
         <if test="dto.endTime != null and dto.endTime != ''" >    
            and  <![CDATA[  t1.end_ <=  to_date(#{dto.endTime},'yyyy-MM-dd')+1 ]]>
        </if>
		<if test="dto.bizInfName != null and dto.bizInfName != ''">
        	and exists (select b.biz_inf_name from jbpm4_biz_tab b 
        		where  b.pro_instance_id =(select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
					   from jbpm4_hist_procinst hp where hp.id_=t1.id_)
				and b.biz_inf_name like '%'||#{dto.bizInfName}||'%'
			)
        </if>
        <if test="dto.bizType != null and dto.bizType != ''">
        	and exists (select * from jbpm4_biz_tab bt where bt.biz_type =#{dto.bizType}
            	and bt.pro_instance_id in(
						select case when hp.main_id_ is not null then hp.main_id_ else hp.id_ end pro_instance_id 
					   	from jbpm4_hist_procinst hp where hp.id_=t1.id_
				)
			)
        </if>
			order by t1.end_ desc
	</select>
	<!-- 批量 转移 待办至 其他人员名下 -->
	<update id="batchUpdateAssignee" parameterType="java.util.HashMap">
       begin 
       
		<if test="taskList != null" >    
	        <foreach collection="taskList" item="taskInfo" >
	        	insert into jbpm4_consigned_task(id,validate_state,created_by,created
		        	,task_id
	        		,task_type
	        		,from_user_id
	        		,to_user_id) 
	        		values(seq_jbpm4_consigned_task.nextval,'1', #{taskInfo.operateId},sysdate
	        		,#{taskInfo.taskId}
	        		,''
	        		,(select ht.assignee_ from jbpm4_hist_task ht where ht.dbid_ = #{taskInfo.taskId})
	        		,#{taskInfo.toUserId}
					);
					
				update jbpm4_task t 
				set  t.assignee_ = #{taskInfo.toUserId}
				where t.dbid_ =  #{taskInfo.taskId};
				
				update jbpm4_hist_task ht 
				set  ht.assignee_ = #{taskInfo.toUserId}
				where ht.dbid_ =  #{taskInfo.taskId};
				
     		</foreach>
        </if>
        
      
       end;
  </update>
  
<!-- 通过jbpm4_biz_tab id 查询 其对应流程实例的第一个待办任务信息 -->  
<select id="getFirstTaskByBizTabId" parameterType="java.util.HashMap" resultType="java.util.HashMap" >
	select 
		  bt.pro_instance_id 
	from jbpm4_biz_tab bt 
	where bt.id='${bizTabId}'
</select>  

<!-- 更改  的字段的值 -->
<update id="updateDataLockByPrimaryKey" parameterType="java.util.Map">
		update jbpm4_task j 
			set j.lock_state= #{state}
		where j.dbid_ in (${ids})
</update>
<!-- 更新 流程监控  批量恢复、挂起的字段 -->
<update id="batchUpdateStateByIds" parameterType="java.util.Map">
	    update jbpm4_biz_tab j 
		 	set j.pro_instance_state = #{state}
  		where j.pro_instance_id in( ${ids})
</update>
<!-- 查看流程执行 轨迹信息 -->
<select id="viewWorkflowHisLogByPaging" parameterType="java.util.HashMap" resultType="java.util.HashMap" >
	select 
			to_char(h.create_ ,'yyyy-MM-dd hh24:mi:ss') 	start_time
	       ,to_char(h.end_ ,'yyyy-MM-dd hh24:mi:ss') 		end_time
	       ,h.assignee_ 	exe_user_id
	       ,h.outcome_  	outcome
	       ,h.execution_    pro_ins_id
	       ,(select a.activity_name_ from jbpm4_hist_actinst a where a.htask_ = h.dbid_) 	act_name
	from jbpm4_hist_task h 
	where 1 = 1
	<if test="processInstantceId != null and processInstantceId != '' " >
		and h.execution_ in	
		(select hp.id_ from jbpm4_hist_procinst hp where hp.main_id_='${processInstantceId}' or hp.id_ ='${processInstantceId}' )
	</if>
	<if test="processInstantceId == null or processInstantceId == '' " >
		and h.execution_ in	
		(select hp.id_ from jbpm4_hist_procinst hp where 
		hp.main_id_  in (select b.pro_instance_id from jbpm4_biz_tab  b  where  b.biz_tab_name='${bizTabName}' and b.biz_inf_id='${bizInfId}') 
		or hp.id_  in (select b.pro_instance_id from jbpm4_biz_tab  b  where  b.biz_tab_name='${bizTabName}' and b.biz_inf_id='${bizInfId}') 
		)
	</if>
	order by h.dbid_ desc 
</select> 
<!-- 查看流程执行 轨迹信息 查询活动历史表  包含task、custom、decision 类型的活动-->
<select id="viewActHisLogByPaging" parameterType="java.util.HashMap" resultType="java.util.HashMap" >
	select 
			to_char(a.start_, 'yyyy-MM-dd hh24:mi:ss')	start_time
	       ,to_char(a.end_ ,'yyyy-MM-dd hh24:mi:ss') end_time
	       ,(select t.assignee_ from  jbpm4_hist_task t where t.dbid_=a.htask_ ) 	exe_user_id
	       ,a.transition_  	outcome
	       ,a.execution_    pro_ins_id
	       ,a.activity_name_ act_name
	from jbpm4_hist_actinst a
	where 1 = 1
	and a.type_ in('task','custom','decision')
	<if test="processInstantceId != null and processInstantceId != '' " >
		and a.execution_ in	
		(select hp.id_ from jbpm4_hist_procinst hp where hp.main_id_='${processInstantceId}' or hp.id_ ='${processInstantceId}' )
	</if>
	<if test="processInstantceId == null or processInstantceId == '' " >
		and a.execution_ in	
		(select hp.id_ from jbpm4_hist_procinst hp where 
		hp.main_id_  in (select b.pro_instance_id from jbpm4_biz_tab  b  where  b.biz_tab_name='${bizTabName}' and b.biz_inf_id='${bizInfId}') 
		or hp.id_  in (select b.pro_instance_id from jbpm4_biz_tab  b  where  b.biz_tab_name='${bizTabName}' and b.biz_inf_id='${bizInfId}') 
		)
	</if>
	and (a.transition_ is null or a.transition_ not like 'regect%')
	order by a.start_ desc 
</select> 
<!-- 查看流程实例下 某个节点的 执行 轨迹信息 -->
<select id="queryExecuteHisLog" parameterType="java.util.HashMap" resultType="java.util.HashMap" >
	select 
			to_char(h.create_ ,'yyyy-MM-dd hh24:mi:ss') 	start_time
	       ,to_char(h.end_ ,'yyyy-MM-dd hh24:mi:ss') 		end_time
	       ,h.assignee_ 	exe_user_id
	       ,h.outcome_  	outcome
	       
	from jbpm4_hist_task h 
	where 1 = 1
	and exists (select * from jbpm4_hist_actinst a where  a.activity_name_ = '${actName}' and a.htask_= h.dbid_ and a.execution_ = h.execution_ )
	and h.execution_='${proInsId}'
	and h.state_='completed'
	order by h.dbid_ desc 
</select> 

<!-- 查询 流程实例下 未执行的 待办任务信息 -->
<select id="getTaskInfoByProInsId" parameterType="java.util.HashMap" resultType="java.util.HashMap" >
	select 
			to_char(t.dbid_) 			task_id
			,t.lock_state				lock_state
      		,t.activity_name_			activity_name
 	from jbpm4_task t  
 	where 1 =1
 	and t.execution_id_= '${proInsId}'
 	order by t.dbid_ desc 
</select> 

<!-- 通过 taskId 查询  待办任务信息 -->
<select id="getTaskInfByTaskId" parameterType="java.util.HashMap" resultType="java.util.HashMap" >
	select 
			to_char(t.dbid_) 			task_id
			,t.lock_state				lock_state
      		,t.activity_name_			activity_name
      		,t.assignee_				cur_user_id
 	from jbpm4_task t  
 	where 1 =1
 	and t.dbid_= '${taskId}'
</select> 
<!-- 获取 历史任务信息 -->
<select id="getHisTaskInf" parameterType="java.util.HashMap" resultType="java.util.HashMap" >
		select 
			ht.assignee_ 		HIS_USER_ID
		    ,ht.DBID_                           
			,ht.DBVERSION_                      
			,ht.EXECUTION_                      
			,ht.OUTCOME_                        
			,ht.ASSIGNEE_                       
			,ht.PRIORITY_                       
			,ht.STATE_                          
			,ht.CREATE_                         
			,ht.END_                            
			,ht.DURATION_                       
			,ht.NEXTIDX_                        
			,ht.SUPERTASK_  
		from jbpm4_hist_task ht where 1 = 1
		
		and ht.dbid_ = (
			select  max(ht.dbid_)
			from jbpm4_hist_task ht where 1 = 1
			and exists (
				select h.htask_ from jbpm4_hist_actinst h 
				where h.execution_ in( select * from (
										select p.id_  from jbpm4_hist_procinst p where 1= 1
										and p.id_ in ( select bt.pro_instance_id  from jbpm4_biz_tab bt  where bt.validate_state='1'  and bt.biz_tab_name=#{bizTabName} and bt.biz_inf_id = #{bizInfId} )
										<!-- or p.main_id_ in(select bt.pro_instance_id  from jbpm4_biz_tab bt  where bt.validate_state='1'  and bt.biz_tab_name='${bizTabName}' and bt.biz_inf_id='${bizInfId}') -->
										union all select p.id_  from jbpm4_hist_procinst p where 1= 1
										and p.main_id_ in ( select bt.pro_instance_id  from jbpm4_biz_tab bt  where bt.validate_state='1'  and bt.biz_tab_name=#{bizTabName} and bt.biz_inf_id=#{bizInfId} )
										)
				)
				and h.activity_name_=#{actName}
				and h.end_ is not null
				and h.htask_ = ht.dbid_
			)
		)
		
</select> 

<!-- 获取 历史任务信息  根据业务类型-->
<select id="getHisTaskInfByBizType" parameterType="java.util.HashMap" resultType="java.util.HashMap" >
	select 
			ht.assignee_ 		HIS_USER_ID
		    ,ht.DBID_                           
			,ht.DBVERSION_                      
			,ht.EXECUTION_                      
			,ht.OUTCOME_                        
			,ht.ASSIGNEE_                       
			,ht.PRIORITY_                       
			,ht.STATE_                          
			,ht.CREATE_                         
			,ht.END_                            
			,ht.DURATION_                       
			,ht.NEXTIDX_                        
			,ht.SUPERTASK_  
		from jbpm4_hist_task ht where 1 = 1
		
		and ht.dbid_ = (
			select  max(ht.dbid_)
			from jbpm4_hist_task ht where 1 = 1
				and exists (
				select h.htask_ from jbpm4_hist_actinst h 
				where h.execution_ in(select * from ( select p.id_  from jbpm4_hist_procinst p where 1= 1
										and p.id_ in ( select bt.pro_instance_id  from jbpm4_biz_tab bt  where bt.validate_state='1'  and bt.biz_type in ${bizType} and bt.biz_inf_id= #{bizInfId} )
										<!-- or p.main_id_ in(select bt.pro_instance_id  from jbpm4_biz_tab bt  where bt.validate_state='1'  and bt.biz_type in ${bizType} and bt.biz_inf_id='${bizInfId}') -->
										
										union all select p.id_  from jbpm4_hist_procinst p where 1= 1
										and p.main_id_ in ( select bt.pro_instance_id  from jbpm4_biz_tab bt  where bt.validate_state='1'  and bt.biz_type in ${bizType} and bt.biz_inf_id=#{bizInfId} )
										)
				)
				and h.activity_name_='${actName}'
				and h.end_ is not null
				and h.htask_ = ht.dbid_
			)
		)
		<!-- 
		优化后的sql
		select ht.assignee_ HIS_USER_ID
from jbpm4_hist_task ht ,jbpm4_hist_actinst hta,jbpm4_hist_procinst hp ,jbpm4_biz_tab bt
where ht.dbid_=hta.htask_  and hta.hproci_=hp.dbid_ and hta.activity_name_=#{actName}  and hta.end_  is not null  and hp.id_=bt.pro_instance_id  
and bt.validate_state='1'  and bt.biz_type in ${bizType} and bt.biz_inf_id=#{bizInfId}  -->
		
</select> 
<!-- 获取 最后一个历史任务信息  根据业务类型-->
<select id="getLastHisUserOfActiveByBizType" parameterType="java.util.HashMap" resultType="java.util.HashMap" >
		select 
			ht.assignee_ 			HIS_USER_ID
		    ,ht.DBID_                           
			,ht.DBVERSION_                      
			,ht.EXECUTION_                      
			,ht.OUTCOME_                        
			,ht.ASSIGNEE_                       
			,ht.PRIORITY_                       
			,ht.STATE_                          
			,ht.CREATE_                         
			,ht.END_                            
			,ht.DURATION_                       
			,ht.NEXTIDX_                        
			,ht.SUPERTASK_                  
			    
		from jbpm4_hist_task ht where 1 = 1
		
		and ht.dbid_ = (
			select  max(ht1.dbid_)
			from jbpm4_hist_task ht1 where 1 = 1
				and exists (
				select h.htask_ from jbpm4_hist_actinst h 
				where h.execution_ in(<!-- select * from ( --> select p.id_  from jbpm4_hist_procinst p where 1= 1
										and p.id_ in ( select bt.pro_instance_id  from jbpm4_biz_tab bt  where bt.validate_state='1'  and bt.biz_type in ${bizType} and bt.biz_inf_id=#{bizInfId} )
										<!-- or p.main_id_ in(select bt.pro_instance_id  from jbpm4_biz_tab bt  where bt.validate_state='1'  and bt.biz_type in ${bizType} and bt.biz_inf_id='${bizInfId}') -->
										<!-- union all select p.id_  from jbpm4_hist_procinst p where 1= 1
										and p.main_id_ in ( select bt.pro_instance_id  from jbpm4_biz_tab bt  where bt.validate_state='1'  and bt.biz_type in ${bizType} and bt.biz_inf_id=#{bizInfId} )
										) -->
				)
				and h.activity_name_ like '%'||#{actName}||'%'
				and h.end_ is not null
				and h.htask_ = ht1.dbid_
			)
		)
		
</select> 
<!-- 根据流程实例ID获取 历史任务信息 暂不考虑主子流程 -->
<select id="getHisTaskInfByProInstId" parameterType="java.util.HashMap" resultType="java.util.HashMap" >
		select 
			ht.assignee_ 	HIS_USER_ID
		    ,ht.DBID_                           
			,ht.DBVERSION_                      
			,ht.EXECUTION_                      
			,ht.OUTCOME_                        
			,ht.ASSIGNEE_                       
			,ht.PRIORITY_                       
			,ht.STATE_                          
			,ht.CREATE_                         
			,ht.END_                            
			,ht.DURATION_                       
			,ht.NEXTIDX_                        
			,ht.SUPERTASK_  
		from jbpm4_hist_task ht where 1 = 1
		
		and ht.dbid_ = (
			select  max(ht.dbid_)
			from jbpm4_hist_task ht where 1 = 1
			and exists (
				select h.htask_ from jbpm4_hist_actinst h 
				where h.execution_ = #{proInstId}
				<!-- in(select * from ( select p.id_  from jbpm4_hist_procinst p 
													where p.id_ = #{proInstId}
													union all
													select p.id_  from jbpm4_hist_procinst p 
													where p.main_id_ = #{proInstId}
													)
														
				) -->
				and h.activity_name_=#{actName}
				and h.end_ is not null
				and h.htask_ = ht.dbid_
			)
		)
		
</select> 

<!-- 通过流程实例id和活动名称查询任务信息-->
<select id="getActInstByProInstIdAndActName" parameterType="java.util.HashMap" resultType="java.util.HashMap" >
	select t.assignee_ performer,to_char(a.end_ ,'yyyy-MM-dd hh24:mi:ss') completeTime,a.activity_name_ actName
	from jbpm4_hist_actinst a left join jbpm4_hist_task t on a.htask_=t.dbid_
	where a.execution_='${proInstId}'
	and a.activity_name_='${actName}'
	order by a.dbid_ desc
</select> 

<!-- 获取当前任务信息-->
<select id="getCurTaskInfo" parameterType="java.util.HashMap" resultType="java.util.HashMap" >
	select t.name_ ACTNAME,t.assignee_ PERFORMER  from jbpm4_task t,jbpm4_biz_tab b
 	where t.execution_id_=b.pro_instance_id
 	and b.biz_inf_id='${bizInfId}'
 	and b.biz_type='${bizType}'
 	order by t.create_ desc
</select>
<!-- 更改任务超时提醒的状态 -->
<update id="updateJbpm4BizTabTaskEmergentState" parameterType="java.util.HashMap">
		update jbpm4_biz_tab t set t.task_state='${emergentState}'
		where t.id='${jbpm4BizTabId}'
</update>
<!-- 获取父流程 -->
<select id="getParentProcess" parameterType="java.util.HashMap" resultType="java.lang.String">
     select t.main_id_ from jbpm4_hist_procinst t where t.id_='${proInstId}'
</select>
<!-- 判断员工是否请假 -->
<select id="checkLeaveByUserId" parameterType="java.util.Map" resultType="java.util.Map">
    	    select 
    	    		to_char(count(*)) cun
    	    		
			       from SYS_LEAVE_INFO l 
			      where l.validate_state='1'
			      and l.status='2'
			      <![CDATA[ and to_char(l.start_time,'yyyy-MM-dd') <= to_char(sysdate,'yyyy-MM-dd')]]>
			      <![CDATA[ and to_char(l.end_time,'yyyy-MM-dd') >= to_char(sysdate,'yyyy-MM-dd')]]>
			      and l.leave_user_id='${userId}'
</select>
<!-- 通过平台公共分页查询 个人的已结的历史任务 流程实例是结束的 不支持 主子流程 会签流程  by xyz-->
<select id="queryPersonalEndHistTaskInfoByPaging" parameterType="java.util.HashMap" resultType="java.util.HashMap">
	        select 
				 t1.ID
				,t1.ID				BIZ_TAB_ID
				,t1.BIZ_TAB_NAME
				,t1.BIZ_TYPE
				,t1.BIZ_INF_ID
				,t1.BIZ_INF_NAME
				,t1.BIZ_TASK_TYPE
				,t1.PRO_INSTANCE_ID
				,t1.PRO_INSTANCE_ID CUR_EXE_ID
				,t1.START_PRO_USERID
				,t1.PRO_INSTANCE_STATE
				,t1.TASK_STATE
				,t1.OWNER_ID
				,t1.ORG_ID
				,to_char(t1.CREATE_TIME ,'YYYY-MM-DD HH24:MI:SS') CREATE_TIME
				, to_char(h1.end_ ,'YYYY-MM-DD HH24:MI:SS')  PRO_END_TIME
				,t1.REMARK
				,t1.IS_HIDDEN
				
				from jbpm4_biz_tab_old t1,jbpm4_hist_procinst_old h1
				where t1.validate_state='1' and  h1.id_=t1.pro_instance_id
				<!--考虑一条业务数据多次审核-->
				and t1.id in (select max(t2.id) from jbpm4_biz_tab_old t2 where t2.validate_state='1'
				<!--判断流程是否 已经办结-->
				and exists (select hp.* from jbpm4_hist_procinst_old hp where hp.end_ is not null  and hp.id_=t2.pro_instance_id )
               <if test="dto.paramUserId != null" > 
				and exists (select ht.execution_ from jbpm4_hist_task_old ht where ht.assignee_ ='${dto.paramUserId}'  and  ht.execution_  = t2.pro_instance_id )
			    </if>
			    <if test="dto.processParticipationName != null and dto.processParticipationName != ''" >    
	            and exists (select ht.execution_ from jbpm4_hist_task_old ht where ht.assignee_ in (${dto.processParticipationName})  and  ht.execution_  = t2.pro_instance_id )
	        	</if>
			    <if test="dto.processInsId !=null and dto.processInsId!=''">
			    	and t2.pro_instance_id=#{dto.processInsId}
			    </if>
			    <if test="dto.startTime != null and dto.startTime != ''" >    
		            and  <![CDATA[  t2.create_time >= to_date(#{dto.startTime},'yyyy-MM-dd') ]]>
		        </if>
		        <if test="dto.endTime != null and dto.endTime != ''" >    
		            and  <![CDATA[  t2.create_time <=  to_date(#{dto.endTime},'yyyy-MM-dd')+1 ]]>
		        </if>
				<if test="dto.busInfoName != null and dto.busInfoName != '' " >    
		            and t2.biz_inf_name like '%'||#{dto.busInfoName}||'%' 
		        </if>
		        <if test="dto.busInfoId != null and dto.busInfoId != '' " >    
		            and t2.biz_inf_id like '%'||#{dto.busInfoId}||'%' 
		        </if>
		        <if test="dto.bizTaskType != null and dto.bizTaskType != '' " >    
		            and t2.biz_task_type =#{dto.bizTaskType}
		        </if>
		        <if test="dto.remark != null and dto.remark != '' " >    
		            and t2.remark like '%'||#{dto.remark}||'%'
		        </if>
		        <!--  任务类型 -->
		        <if test="dto.bizType != null and dto.bizType != ''">
		        	and t2.biz_type = #{dto.bizType}
		        </if>
		        
				group by t2.biz_tab_name,t2.biz_inf_id,t2.biz_type)
				
		        <!--自定义业务表与工作流表关联的sql条件控制-->
		        <if test="myExtSQL != null and myExtSQL != ''">
		        	${myExtSQL}
		        </if>
			     <!--自定义工作流 数据权限控制-->
		        <if test="dataCSQL != null and dataCSQL != ''">
		        	${dataCSQL}
		        </if>
		        <!--角色映射权限控制-->
		        <if test="dto.roleMappingSql != null and dto.roleMappingSql != ''">
		        	${dto.roleMappingSql}
		        </if>
		        
			order by t1.id desc 
</select>
<!-- 通过历史流程实例ID 查询相关流程定义信息  by xyz-->
<select id="queryProDefindInfoByHistData" parameterType="java.util.Map" resultType="java.util.Map">
	  select  
	  		t1.OBJNAME_     pro_name	
	       ,t1.DEPLOYMENT_  deployment	
	       ,t2.stringval_   pro_key		
	       ,t3.longval_    	version		
	       ,t1.stringval_  	pro_def_id  
	       ,to_char((select tt1.name_ from jbpm4_lob tt1 where tt1.deployment_ = t1.deployment_)) resource_name /*流程资源名称*/
	  from JBPM4_DEPLOYMENT t,
	       JBPM4_DEPLOYPROP t1,
	       JBPM4_DEPLOYPROP t2,
	       JBPM4_DEPLOYPROP t3
	 where t1.KEY_ = 'pdid'
	   and t1.DEPLOYMENT_ = t.DBID_
	   and t2.KEY_ = 'pdkey'
	   and t2.OBJNAME_ = t1.OBJNAME_
	   and t2.DEPLOYMENT_ = t.DBID_
	   and t3.KEY_ = 'pdversion'
	   and t3.OBJNAME_ = t1.OBJNAME_
	   and t3.DEPLOYMENT_ = t.DBID_
	   and t1.STRINGVAL_ = (select hp.procdefid_ from jbpm4_hist_procinst_old hp where hp.id_='${proInsId}')
   </select>
   <!-- 分页查询历史实例数据  by xyz-->
   <select id="viewActHisLogForHistByPaging" parameterType="java.util.HashMap" resultType="java.util.HashMap" >
	select 
			to_char(a.start_, 'yyyy-MM-dd hh24:mi:ss')	start_time
	       ,to_char(a.end_ ,'yyyy-MM-dd hh24:mi:ss') end_time
	       , (select t.assignee_ from  jbpm4_hist_task_old t where t.dbid_=a.htask_ ) 	exe_user_id
	       ,a.transition_  	outcome
	       ,a.execution_    pro_ins_id
	       ,a.activity_name_ act_name
	from jbpm4_hist_actinst_old a
	where 
	 a.type_ in('task','custom','decision')
	<if test="processInstantceId != null and processInstantceId != '' " >
		 and exists
		(select hp.id_ from jbpm4_hist_procinst_old hp where hp.dbid_=a.hproci_  and  (hp.main_id_='${processInstantceId}' or hp.id_ ='${processInstantceId}') )
	</if>
	<if test="processInstantceId == null or processInstantceId == '' " >
		and exists	
		(select hp.id_ from jbpm4_hist_procinst_old hp where 
		hp.main_id_  in (select b.pro_instance_id from jbpm4_biz_tab_old  b  where  b.biz_tab_name='${bizTabName}' and b.biz_inf_id='${bizInfId}') 
		or hp.id_  in (select b.pro_instance_id from jbpm4_biz_tab_old  b  where  b.biz_tab_name='${bizTabName}' and b.biz_inf_id='${bizInfId}') 
		)
	</if>
	and (a.transition_ is null or a.transition_ not like 'regect%')
	order by a.start_ desc 
</select>
   
 <!-- 获取图片内容  by xyz-->   
<select id="queryProPngByProNameAndVersionByHist" parameterType="java.util.HashMap" resultMap="proPng" >
  	 		select 
				t1.pro_png
		from temporary_jbpm4_info 		t1
		where 1 =1 
 				
 				<if test="id != null and id != '' " >    
				 and t1.id=#{id}
		</if>
		<if test="processName != null and processName != ''" >    
				and t1.proc_name=#{processName}
		</if>
		<if test="processVersion != null and processVersion != ''" >    
				and t1.proc_version=#{processVersion}
		</if>
		<if test="processInstantceId != null and processInstantceId != '' " >    
				and t1.proc_name=(select d.objname_ from jbpm4_deployprop d where 
 										d.stringval_=(select p.procdefid_ from jbpm4_hist_procinst_old p where instr(#{processInstantceId},p.id_)>0 ))	
			and t1.proc_version =
			(select d1.longval_ from jbpm4_deployprop d1 where d1.key_='pdversion' 
			and d1.objname_ = (select d.objname_ from jbpm4_deployprop d 
										where d.stringval_=(select p.procdefid_ from jbpm4_hist_procinst_old p where instr(#{processInstantceId},p.id_)>0)
							  )
			)
		</if>
		<!-- 通过流程定义key 查找流程图 则取最新的流程图 -->
		<if test="processDefKey != null and processDefKey != '' " >    
				and t1.proc_name=( 
 										select tt.objname_ from (
									select d.objname_ ,max(d.deployment_) max_deployment_id 
										from jbpm4_deployprop d 
										where d.stringval_=#{processDefKey} 
										group by d.objname_ 
									) tt
 										)	
			and t1.proc_version =
			(select d1.longval_ from jbpm4_deployprop d1 where d1.key_='pdversion' 
			and d1.deployment_ = (select tt.max_deployment_id from (
									select d.objname_ ,max(d.deployment_) max_deployment_id 
										from jbpm4_deployprop d 
										where d.stringval_=#{processDefKey} 
										group by d.objname_ 
									) tt
							  )
			)
		</if>
		and t1.pro_png is not null 
</select>
   
</mapper>